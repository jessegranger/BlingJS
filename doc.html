<html>
	<head>
		<script src="bling.js"></script>
		<link href='http://fonts.googleapis.com/css?family=Nobile' rel='stylesheet' type='text/css'>
		<style>
			.template { display: none; }
			body {
				font-family: 'Nobile', Verdana, sans;
			}
			b { color:#911; }
			i { color:#822; }
			p {
				width:300px;
				text-align: justify;
				margin-left:auto;
				margin-right:auto;
			}
			a[href^='#doc:Bling'] {
				font-size: 20px;
				text-decoration:none;
				color:black;
				border-bottom: 1px solid black;
			}
		</style>
		<script>
			$.ready(function() {
				var $body = $("body"),
					$docroot = $("#docroot"),
					i = 0, j = 0, module = null,
					example_re = /\s*[Ee]xample:\s*/,
					end_line = /\n/g,
					code_line = /^\s*>\s/,
					blank_line = /^\s*$/,
					singleline_comment = /^\/\/ */,
					multiline_comment_open = /^\/\* */,
					multiline_comment_close = /\s*\*\/\s*$/,
					b_word = /\/(\w+)\//g,
					i_word = /_(\w+)_/g,
					progressBar = $.UI.ProgressBar("#progress-bar")

				function getSource(func) {
					return $(Function.PrettyPrint(func))
				}
				function getDescription(node) {
					var desc = node.find(".com").take(1).text().first();
					desc = desc ? desc
						.replace(singleline_comment,'')
						.replace(b_word, "<b>$1</b>")
						.replace(i_word, "<i>$1</i>")
						: "unknown - unknown"
					return desc.split(" - ")
				}
				function getExamples(node) {
					// return a list of [<p>, <pre>, <p>, <pre>, ...]
					var examples = node.find(".com").skip(1).text(),
						result = $([]), codeQueue = [], paraQueue = [],
						i = 0, j = 0, n = examples.length, example = null
						lines = null, line = null

					while( example = examples[i++] ) {
						if( example_re.test(example) ) {
							console.log("example", example)
							lines = example.split(end_line)
							while( line = lines[i++] ) {
								console.log("line", line)
								if( code_line.test(line) ) {
									console.log("code queue")
									codeQueue.push(line.replace(code_line, ''))
									if( paraQueue.length > 0 ) {
										console.log("para flush")
										result.push($("<p>").html(paraQueue.join('\n')))
										paraQueue = []
									}
								}
								else if( ! blank_line.test(line) ) {
									console.log("para queue")
									paraQueue.push(line.replace(/\*\//g,""))
									if( codeQueue.length > 0 ) {
										console.log("code flush")
										result.push($(Function.PrettyPrint(codeQueue.join('\n'))))
										codeQueue = []
									}
								}
							}
						}
					}
					if( codeQueue.length > 0 ) {
						result.push($(Function.PrettyPrint(codeQueue.join('\n'))))
					}
					if( paraQueue.length > 0 ) {
						result.push($("<p>").html(paraQueue.join('\n')))
					}
					return result
				}

				function generateModuleDocs(module, template) {
					var ul = $("<ol class='apilist' module='"+name+"'></ol>")
					for( var k in module ) {
						var source = getSource(module[k]),
							desc = getDescription(source),
							examples = getExamples(source)
						ul.append(template.render({
							coderef: "Bling.prototype."+k, 
							funcdef: desc[0], 
							funcdesc: desc[1]
						}))
						.find("li")
						.last(1)
						.append(examples)
					}
					ul.find("a").cycle('click', function() {
						var $this = $(this),
							name = $this.attr('name').first(),
							func = eval(name),
							source = getSource(func)
						source.find(".com").filter(function() {
							return this.innerText.indexOf("Example:") > -1
						}).remove()
						$this.parent()
							.append("<h6>Implementation:</h6>")
							.append(source)
							.find("h6, h6 + pre").click(function () {
								$(this).parent().find("h6, pre").remove()
							})
						return false
					}, function() {
						var $this = $(this)
						$this.parent().find("h6, h6 + pre").remove()
					})
					return ul
				}

				var funcTemplate = $("#func-template").template()
				setTimeout(function () {
					if( name = Bling.module.order[i++] ) {
						module = Bling.module[name]
						var h3 = $("<h3>"+name+"</h3>"),
							ul = generateModuleDocs(module, funcTemplate)
						h3.click(function() {
							ul.toggle()
						})
						$docroot.append(h3).append(ul)
						// update progress bar
						progressBar.update(i/Bling.module.order.length)
						setTimeout(arguments.callee, 0)
					} else {
						// hide the progress bar, fade the docs in
						progressBar.hide(function() {
							$docroot.fadeIn()
						})
					}
				}, 0)
				$docroot.hide()

				$body.find(".func").click(function() {
					var $this = $(this),
						module_name = $this.parents().filter(".module").attr('module'),
						span = $this.find("span").take(1),
						name = span.text().first()
				})
			})
		</script>
	</head>
	<body>
		<div id="progress-bar"> </div>
		<div id="docroot">
		</div>
		<div id="func-template" class="template">
			<li><a name="%(coderef)s" href="#doc:%(coderef)s"><span>%(funcdef)s</span></a>&nbsp;&mdash;&nbsp;%(funcdesc)s</li>
		</div>
	</body>
</html>
