<!DOCTYPE html>  <html> <head>   <title>bling.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               bling.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="o">or=</span> <span class="nf">(o) -&gt;</span> <span class="p">(</span><span class="nx">k</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">o</span><span class="p">)</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">values</span> <span class="o">or=</span> <span class="nf">(o) -&gt;</span> <span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">o</span><span class="p">)</span>
<span class="nv">extend = </span><span class="nf">(a, b) -&gt;</span>
  <span class="k">if</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">a</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">b</span> <span class="k">when</span> <span class="nx">v</span><span class="o">?</span>
  <span class="nx">a</span>
<span class="k">class</span> <span class="nx">Bling</span>
  <span class="nv">constructor: </span><span class="nf">(args...) -&gt;</span>
    <span class="k">return</span> <span class="nx">Bling</span><span class="p">.</span><span class="nx">hook</span> <span class="s">&quot;bling-init&quot;</span><span class="p">,</span> <span class="nx">args</span>
  <span class="vi">@plugin: </span><span class="nf">(opts, constructor) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">constructor</span>
      <span class="nv">constructor = </span><span class="nx">opts</span>
      <span class="nv">opts = </span><span class="p">{}</span>
    <span class="k">if</span> <span class="s">&quot;depends&quot;</span> <span class="k">of</span> <span class="nx">opts</span>
      <span class="k">return</span> <span class="nx">@depends</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">depends</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="nx">@plugin</span> <span class="p">{</span> <span class="nv">provides: </span><span class="nx">opts</span><span class="p">.</span><span class="nx">provides</span> <span class="p">},</span> <span class="nx">constructor</span>
    <span class="k">try</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">plugin = </span><span class="nx">constructor</span><span class="o">?</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@</span><span class="p">,</span><span class="nx">@</span><span class="p">)</span>
        <span class="nx">extend</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">plugin</span><span class="o">?</span><span class="p">.</span><span class="nx">$</span>
        <span class="p">[</span><span class="s">&#39;$&#39;</span><span class="p">,</span><span class="s">&#39;name&#39;</span><span class="p">].</span><span class="nx">forEach</span> <span class="nf">(k) -&gt;</span> <span class="k">delete</span> <span class="nx">plugin</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
        <span class="nx">extend</span> <span class="nx">@</span><span class="o">::</span><span class="p">,</span> <span class="nx">plugin</span>
        <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">plugin</span> <span class="k">then</span> <span class="nx">do</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">or=</span> <span class="p">(</span><span class="nx">a</span><span class="p">...)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">@</span><span class="o">::</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">apply</span> <span class="nx">Bling</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">...])</span>
        <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">provides</span><span class="o">?</span> <span class="k">then</span> <span class="nx">@provide</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">provides</span>
    <span class="k">catch</span> <span class="nx">error</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;failed to load plugin: </span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">error</span><span class="p">.</span><span class="nx">stack</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">@</span>
  <span class="nv">dep =</span>
    <span class="nv">q: </span><span class="p">[]</span>
    <span class="nv">done: </span><span class="p">{}</span>
    <span class="nv">filter: </span><span class="nf">(n) -&gt;</span>
      <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">n</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span> <span class="k">then</span> <span class="nx">n</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/, */</span> <span class="k">else</span> <span class="nx">n</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">filter</span> <span class="nf">(x) -&gt;</span> <span class="o">not</span> <span class="p">(</span><span class="nx">x</span> <span class="k">of</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span>
  <span class="vi">@depends: </span><span class="nf">(needs, f) -&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">needs = </span><span class="nx">dep</span><span class="p">.</span><span class="nx">filter</span> <span class="nx">needs</span><span class="p">).</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">f</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">dep</span><span class="p">.</span><span class="nx">q</span><span class="p">.</span><span class="nx">push</span> <span class="nf">(need) -&gt;</span>
        <span class="p">(</span><span class="nx">needs</span><span class="p">.</span><span class="nx">splice</span> <span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nv">i = </span><span class="nx">needs</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">need</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">needs</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">f</span><span class="p">)</span>
    <span class="nx">f</span>
  <span class="vi">@provide: </span><span class="nf">(needs, data) -&gt;</span>
    <span class="k">for</span> <span class="nx">need</span> <span class="k">in</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">filter</span> <span class="nx">needs</span>
      <span class="nx">dep</span><span class="p">.</span><span class="nx">done</span><span class="p">[</span><span class="nx">need</span><span class="p">]</span> <span class="o">=</span> <span class="nv">i = </span><span class="mi">0</span>
      <span class="k">while</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">f = </span><span class="nx">dep</span><span class="p">.</span><span class="nx">q</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="nx">need</span><span class="p">)</span>
          <span class="nx">dep</span><span class="p">.</span><span class="nx">q</span><span class="p">.</span><span class="nx">splice</span> <span class="nx">i</span><span class="p">,</span><span class="mi">1</span>
          <span class="nx">f</span> <span class="nx">data</span>
          <span class="nv">i = </span><span class="mi">0</span> <span class="c1"># start over in case a nested dependency removed stuff &#39;behind&#39; i</span>
        <span class="k">else</span> <span class="nx">i</span><span class="o">++</span>
    <span class="nx">data</span>
<span class="nv">Bling.prototype = </span><span class="p">[]</span>
<span class="nv">Bling.prototype.constructor = </span><span class="nx">Bling</span>
<span class="nv">Bling.global = </span><span class="k">if</span> <span class="nb">window</span><span class="o">?</span> <span class="k">then</span> <span class="nb">window</span> <span class="k">else</span> <span class="nx">global</span>
<span class="nv">$ = </span><span class="nx">Bling</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;EventEmitter&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;type,hook&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">$: EventEmitter: </span><span class="nx">$</span><span class="p">.</span><span class="nx">hook</span><span class="p">(</span><span class="s">&quot;bling-init&quot;</span><span class="p">).</span><span class="nx">append</span> <span class="p">(</span><span class="nv">obj = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">))</span> <span class="o">-&gt;</span>
    <span class="nv">listeners = </span><span class="p">{}</span>
    <span class="nv">list = </span><span class="nf">(e) -&gt;</span> <span class="p">(</span><span class="nx">listeners</span><span class="p">[</span><span class="nx">e</span><span class="p">]</span> <span class="o">or=</span> <span class="p">[])</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">inherit</span> <span class="p">{</span>
      <span class="nv">emit: </span>              <span class="nf">(e, a...) -&gt;</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span> <span class="k">for</span> <span class="nx">f</span> <span class="k">in</span> <span class="nx">list</span><span class="p">(</span><span class="nx">e</span><span class="p">));</span> <span class="nx">@</span>
      <span class="nv">addListener: </span>       <span class="nf">(e, h) -&gt;</span> <span class="nx">list</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span> <span class="nx">@emit</span><span class="p">(</span><span class="s">&#39;newListener&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span>
      <span class="kc">on</span><span class="o">:</span>                 <span class="nf">(e, h) -&gt;</span> <span class="nx">@addListener</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">h</span>
      <span class="nv">removeListener: </span>    <span class="nf">(e, h) -&gt;</span> <span class="p">(</span><span class="nx">list</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">splice</span> <span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nv">i = </span><span class="nx">list</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">indexOf</span> <span class="nx">h</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
      <span class="nv">removeAllListeners: </span><span class="nf">(e) -&gt;</span> <span class="nx">listeners</span><span class="p">[</span><span class="nx">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="nv">setMaxListeners: </span>   <span class="nf">(n) -&gt;</span> <span class="c1"># who really needs this in the core API?</span>
      <span class="nv">listeners: </span>         <span class="nf">(e) -&gt;</span> <span class="nx">list</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">slice</span> <span class="mi">0</span>
    <span class="p">},</span> <span class="nx">obj</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;cartesian&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">$:</span>
    <span class="nv">cartesian: </span><span class="nf">(sets...) -&gt;</span>
      <span class="nv">n = </span><span class="nx">sets</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">ret = </span><span class="p">[]</span>
      <span class="nv">helper = </span><span class="nf">(cur, i) -&gt;</span>
        <span class="p">(</span><span class="k">return</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span> <span class="nx">cur</span><span class="p">)</span> <span class="k">if</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="nx">n</span>
        <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">sets</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
          <span class="nx">helper</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">x</span><span class="p">),</span> <span class="nx">i</span>
        <span class="kc">null</span>
      <span class="nx">helper</span> <span class="p">[],</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span> <span class="o">-&gt;</span>
  <span class="nb">String</span><span class="o">::</span><span class="nx">trimLeft</span> <span class="o">or=</span> <span class="o">-&gt;</span> <span class="nx">@replace</span><span class="p">(</span><span class="sr">/^\s+/</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
  <span class="nb">String</span><span class="o">::</span><span class="nx">split</span> <span class="o">or=</span> <span class="nf">(sep) -&gt;</span>
    <span class="nv">a = </span><span class="p">[];</span> <span class="nv">i = </span><span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">j = </span><span class="nx">@indexOf</span> <span class="nx">sep</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">j</span><span class="p">)</span>
      <span class="nv">i = </span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nx">a</span>
  <span class="nb">String</span><span class="o">::</span><span class="nx">lastIndexOf</span> <span class="o">or=</span> <span class="nf">(s, c, i = -1) -&gt;</span>
    <span class="nv">j = </span><span class="o">-</span><span class="mi">1</span>
    <span class="nv">j = </span><span class="nx">i</span> <span class="k">while</span> <span class="p">(</span><span class="nv">i = </span><span class="nx">s</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nx">j</span>
  <span class="nb">Array</span><span class="o">::</span><span class="nx">join</span> <span class="o">or=</span> <span class="nf">(sep = &#39;&#39;) -&gt;</span>
    <span class="nv">n = </span><span class="nx">@length</span>
    <span class="k">return</span> <span class="s">&quot;&quot;</span> <span class="k">if</span> <span class="nx">n</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="nv">s = </span><span class="nx">@</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">while</span> <span class="o">--</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">s = </span><span class="nx">@</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">sep</span> <span class="o">+</span> <span class="nx">s</span>
    <span class="nx">s</span>
  <span class="k">if</span> <span class="nx">Event</span><span class="o">?</span>
    <span class="nv">Event::preventAll = </span><span class="nf">() -&gt;</span>
      <span class="nx">@preventDefault</span><span class="p">()</span>
      <span class="nx">@stopPropagation</span><span class="p">()</span>
      <span class="vi">@cancelBubble = </span><span class="kc">true</span>
  <span class="k">if</span> <span class="nx">Element</span><span class="o">?</span>
    <span class="nv">Element::matchesSelector = </span><span class="nx">Element</span><span class="o">::</span><span class="nx">webkitMatchesSelector</span> <span class="o">or</span>
      <span class="nx">Element</span><span class="o">::</span><span class="nx">mozMatchesSelector</span> <span class="o">or</span>
      <span class="nx">Element</span><span class="o">::</span><span class="nx">matchesSelector</span>
    <span class="k">if</span> <span class="nx">Element</span><span class="o">::</span><span class="nx">cloneNode</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="nv">oldClone = </span><span class="nx">Element</span><span class="o">::</span><span class="nx">cloneNode</span>
      <span class="nv">Element::cloneNode = </span><span class="nf">(deep = false) -&gt;</span>
        <span class="nv">n = </span><span class="nx">oldClone</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">deep</span>
          <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@childNodes</span>
            <span class="nx">n</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">i</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">true</span>
        <span class="k">return</span> <span class="nx">n</span>
  <span class="k">return</span> <span class="p">{</span> <span class="p">}</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&#39;config&#39;</span>
  <span class="nv">depends: </span><span class="s">&#39;type&#39;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">get = </span><span class="nf">(name, def) -&gt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">?</span> <span class="nx">def</span>
  <span class="nv">$: config: </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">get</span><span class="p">,</span> <span class="nv">get: </span><span class="nx">get</span><span class="p">)</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;core&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;string&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nx">$</span><span class="p">,</span> <span class="s">&quot;now&quot;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span>
  <span class="nv">index = </span><span class="nf">(i, o) -&gt;</span>
    <span class="nx">i</span> <span class="o">+=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">length</span> <span class="k">while</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">length</span>
  <span class="nv">baseTime = </span><span class="nx">$</span><span class="p">.</span><span class="nx">now</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nv">$:</span>
      <span class="nv">log: </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nf">(a...) -&gt;</span>
        <span class="nv">prefix = </span><span class="s">&quot;+</span><span class="si">#{</span><span class="nx">$</span><span class="p">.</span><span class="nx">padLeft</span> <span class="nb">String</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">baseTime</span><span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">prefixSize</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="si">}</span><span class="s">:&quot;</span>
        <span class="k">if</span> <span class="nx">prefix</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">prefixSize</span> <span class="o">+</span> <span class="mi">2</span>
          <span class="nv">prefix = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nv">baseTime = </span><span class="nx">$</span><span class="p">.</span><span class="nx">now</span><span class="si">}</span><span class="s">:&quot;</span>
        <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">prefix</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="k">else</span>
          <span class="nx">a</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">prefix</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">a</span><span class="p">...</span>
        <span class="k">return</span> <span class="nx">a</span><span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span>
      <span class="p">,</span> <span class="nv">prefixSize: </span><span class="mi">5</span><span class="p">)</span>
      <span class="nv">assert: </span><span class="nf">(c, m=&quot;&quot;) -&gt;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">c</span> <span class="k">then</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;assertion failed: </span><span class="si">#{</span><span class="nx">m</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="nv">coalesce: </span><span class="nf">(a...) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">coalesce</span><span class="p">()</span>
      <span class="nv">keysOf: </span><span class="nf">(o) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">k</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">o</span><span class="p">)</span>
      <span class="nv">valuesOf: </span><span class="nf">(o) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">keysOf</span><span class="p">(</span><span class="nx">o</span><span class="p">).</span><span class="nx">map</span> <span class="nf">(k)-&gt;</span>
        <span class="k">return</span> <span class="k">try</span> <span class="nx">o</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="k">catch</span> <span class="nx">err</span> <span class="k">then</span> <span class="nx">err</span>
    <span class="nv">eq: </span><span class="nf">(i) -&gt;</span> <span class="nx">$</span><span class="p">([</span><span class="nx">@</span><span class="p">[</span><span class="nx">index</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">@</span><span class="p">]])</span>
    <span class="nv">each: </span><span class="nf">(f) -&gt;</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="nx">t</span><span class="p">)</span> <span class="k">for</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">@</span><span class="p">);</span> <span class="nx">@</span>
    <span class="nv">map: </span><span class="nf">(f) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="nx">t</span><span class="p">)</span> <span class="k">for</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">@</span><span class="p">)</span>
    <span class="nv">reduce: </span><span class="nf">(f, a) -&gt;</span>
      <span class="nv">i = </span><span class="mi">0</span><span class="p">;</span> <span class="nv">n = </span><span class="nx">@length</span>
      <span class="nv">a = </span><span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">a</span><span class="o">?</span>
      <span class="p">(</span><span class="nv">a = </span><span class="nx">f</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@</span><span class="p">[</span><span class="nx">x</span><span class="p">],</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">@</span><span class="p">[</span><span class="nx">x</span><span class="p">])</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="nx">i</span><span class="p">...</span><span class="nx">n</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
      <span class="k">return</span> <span class="nx">a</span>
    <span class="nv">union: </span><span class="nf">(other, strict = true) -&gt;</span>
      <span class="nv">ret = </span><span class="nx">$</span><span class="p">()</span>
      <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">@</span> <span class="k">when</span> <span class="o">not</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">strict</span><span class="p">)</span>
      <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">other</span> <span class="k">when</span> <span class="o">not</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">strict</span><span class="p">)</span>
      <span class="nx">ret</span>
    <span class="nv">distinct: </span><span class="nf">(strict = true) -&gt;</span> <span class="nx">@union</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">strict</span>
    <span class="nv">intersect: </span><span class="nf">(other) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">x</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">@</span> <span class="k">when</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">other</span><span class="p">)</span> <span class="c1"># another very beatiful expression</span>
    <span class="nv">contains: </span><span class="nf">(item, strict = true) -&gt;</span> <span class="p">((</span><span class="nx">strict</span> <span class="o">and</span> <span class="nx">t</span> <span class="o">is</span> <span class="nx">item</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="o">not</span> <span class="nx">strict</span> <span class="o">and</span> <span class="o">`</span><span class="nx">t</span> <span class="o">==</span> <span class="nx">item</span><span class="o">`</span><span class="p">)</span> <span class="k">for</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">@</span><span class="p">).</span><span class="nx">reduce</span> <span class="p">(</span><span class="nf">(a,x) -&gt;</span> <span class="nx">a</span> <span class="o">or</span> <span class="nx">x</span><span class="p">),</span> <span class="kc">false</span>
    <span class="nv">count: </span><span class="nf">(item, strict = true) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">@</span> <span class="k">when</span> <span class="p">(</span><span class="nx">item</span> <span class="o">is</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">strict</span> <span class="o">and</span> <span class="nx">t</span> <span class="o">is</span> <span class="nx">item</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="o">not</span> <span class="nx">strict</span> <span class="o">and</span> <span class="o">`</span><span class="nx">t</span> <span class="o">==</span> <span class="nx">item</span><span class="o">`</span><span class="p">)).</span><span class="nx">sum</span><span class="p">()</span>
    <span class="nv">coalesce: </span><span class="o">-&gt;</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@</span>
        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;array&quot;</span><span class="p">,</span><span class="s">&quot;bling&quot;</span><span class="p">]</span> <span class="k">then</span> <span class="nv">i = </span><span class="nx">$</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">coalesce</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">i</span><span class="o">?</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">i</span>
      <span class="kc">null</span>
    <span class="nv">swap: </span><span class="nf">(i,j) -&gt;</span>
      <span class="nv">i = </span><span class="nx">index</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">@</span>
      <span class="nv">j = </span><span class="nx">index</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">@</span>
      <span class="k">if</span> <span class="nx">i</span> <span class="o">isnt</span> <span class="nx">j</span>
        <span class="p">[</span><span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">@</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">@</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span><span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span>
      <span class="nx">@</span>
    <span class="nv">shuffle: </span><span class="o">-&gt;</span>
      <span class="nv">i = </span><span class="nx">@length</span><span class="o">-</span><span class="mi">1</span>
      <span class="k">while</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="nx">@swap</span> <span class="o">--</span><span class="nx">i</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">i</span><span class="p">)</span>
      <span class="nx">@</span>
    <span class="nv">select: </span><span class="p">(</span><span class="o">-&gt;</span>
      <span class="nv">getter = </span><span class="nf">(prop) -&gt;</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;function&quot;</span><span class="p">,</span><span class="nv">v = </span><span class="nx">@</span><span class="p">[</span><span class="nx">prop</span><span class="p">])</span> <span class="k">then</span> <span class="nx">$</span><span class="p">.</span><span class="nx">bound</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span><span class="nx">v</span><span class="p">)</span> <span class="k">else</span> <span class="nx">v</span>
      <span class="nv">select = </span><span class="nf">(p) -&gt;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">i = </span><span class="nx">p</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nx">@select</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">substr</span> <span class="mi">0</span><span class="p">,</span><span class="nx">i</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">substr</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span> <span class="nx">@map</span><span class="p">(</span><span class="nx">getter</span> <span class="nx">p</span><span class="p">)</span>
    <span class="p">)()</span>
    <span class="o">or:</span> <span class="nf">(x) -&gt;</span> <span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">or=</span> <span class="nx">x</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@length</span><span class="p">];</span> <span class="nx">@</span>
    <span class="nv">zap: </span><span class="nf">(p, v) -&gt;</span>
      <span class="nv">i = </span><span class="nx">p</span><span class="p">.</span><span class="nx">lastIndexOf</span> <span class="s">&quot;.&quot;</span>
      <span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nv">head = </span><span class="nx">p</span><span class="p">.</span><span class="nx">substr</span> <span class="mi">0</span><span class="p">,</span><span class="nx">i</span>
        <span class="nv">tail = </span><span class="nx">p</span><span class="p">.</span><span class="nx">substr</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="nx">@select</span><span class="p">(</span><span class="nx">head</span><span class="p">).</span><span class="nx">zap</span> <span class="nx">tail</span><span class="p">,</span> <span class="nx">v</span>
        <span class="k">return</span> <span class="nx">@</span>
      <span class="k">switch</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
        <span class="k">when</span> <span class="s">&quot;array&quot;</span><span class="p">,</span><span class="s">&quot;bling&quot;</span> <span class="k">then</span> <span class="nx">@each</span> <span class="o">-&gt;</span> <span class="nx">@</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">v</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
        <span class="k">when</span> <span class="s">&quot;function&quot;</span> <span class="k">then</span> <span class="nx">@zap</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">@select</span><span class="p">(</span><span class="nx">p</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
        <span class="k">else</span> <span class="nx">@each</span> <span class="o">-&gt;</span> <span class="nx">@</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
      <span class="nx">@</span>
    <span class="nv">clean: </span><span class="nf">(prop) -&gt;</span> <span class="nx">@each</span> <span class="o">-&gt;</span> <span class="k">delete</span> <span class="nx">@</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>
    <span class="nv">take: </span><span class="nf">(n = 1) -&gt;</span>
      <span class="nv">end = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">@length</span>
      <span class="nx">$</span><span class="p">(</span> <span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">end</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="nv">skip: </span><span class="nf">(n = 0) -&gt;</span>
      <span class="nv">start = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span><span class="o">|</span><span class="mi">0</span>
      <span class="nx">$</span><span class="p">(</span> <span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">start</span><span class="p">...</span><span class="nx">@length</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="nv">first: </span><span class="nf">(n = 1) -&gt;</span> <span class="k">if</span> <span class="nx">n</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">@</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="nx">@take</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    <span class="nv">last: </span><span class="nf">(n = 1) -&gt;</span> <span class="k">if</span> <span class="nx">n</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">@</span><span class="p">[</span><span class="nx">@length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="nx">@skip</span><span class="p">(</span><span class="nx">@length</span> <span class="o">-</span> <span class="nx">n</span><span class="p">)</span>
    <span class="nv">slice: </span><span class="nf">(start=0, end=@length) -&gt;</span>
      <span class="nv">start = </span><span class="nx">index</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">@</span>
      <span class="nv">end = </span><span class="nx">index</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">@</span>
      <span class="nx">$</span><span class="p">(</span> <span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">start</span><span class="p">...</span><span class="nx">end</span><span class="p">]</span> <span class="p">)</span>
    <span class="nv">extend: </span><span class="nf">(b) -&gt;</span> <span class="nx">@</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">b</span><span class="p">;</span> <span class="nx">@</span>
    <span class="nv">push: </span><span class="nf">(b) -&gt;</span> <span class="nb">Array</span><span class="o">::</span><span class="nx">push</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span> <span class="nx">@</span>
    <span class="nv">filter: </span><span class="nf">(f) -&gt;</span>
      <span class="nv">g = </span><span class="k">switch</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span> <span class="nx">f</span>
        <span class="k">when</span> <span class="s">&quot;string&quot;</span> <span class="k">then</span> <span class="nf">(x) -&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">matchesSelector</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
        <span class="k">when</span> <span class="s">&quot;regexp&quot;</span> <span class="k">then</span> <span class="nf">(x) -&gt;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
        <span class="k">when</span> <span class="s">&quot;function&quot;</span> <span class="k">then</span> <span class="nx">f</span>
        <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;unsupported argument to filter: </span><span class="si">#{</span><span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">$</span><span class="p">(</span> <span class="nx">it</span> <span class="k">for</span> <span class="nx">it</span> <span class="k">in</span> <span class="nx">@</span> <span class="k">when</span> <span class="nx">g</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">it</span><span class="p">,</span><span class="nx">it</span><span class="p">)</span> <span class="p">)</span>
    <span class="nv">matches: </span><span class="nf">(expr) -&gt;</span>
      <span class="k">switch</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span> <span class="nx">expr</span>
        <span class="k">when</span> <span class="s">&quot;string&quot;</span> <span class="k">then</span> <span class="nx">@select</span><span class="p">(</span><span class="s">&#39;matchesSelector&#39;</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span>
        <span class="k">when</span> <span class="s">&quot;regexp&quot;</span> <span class="k">then</span> <span class="nx">@map</span> <span class="nf">(x) -&gt;</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">test</span> <span class="nx">x</span>
        <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;unsupported argument to matches: </span><span class="si">#{</span><span class="nx">$</span><span class="p">.</span><span class="nx">type</span> <span class="nx">expr</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">querySelectorAll: </span><span class="nf">(expr) -&gt;</span>
      <span class="nx">@filter</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">reduce</span> <span class="nf">(a, i) -&gt;</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">i</span><span class="p">.</span><span class="nx">querySelectorAll</span> <span class="nx">expr</span>
      <span class="p">,</span> <span class="nx">$</span><span class="p">()</span>
    <span class="nv">weave: </span><span class="nf">(b) -&gt;</span>
      <span class="nv">c = </span><span class="nx">$</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">@length</span><span class="o">-</span><span class="mi">1</span><span class="p">..</span><span class="mi">0</span><span class="p">]</span> <span class="k">by</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nx">c</span><span class="p">[(</span><span class="nx">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
        <span class="nx">c</span><span class="p">[</span><span class="nx">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="nx">c</span>
    <span class="nv">fold: </span><span class="nf">(f) -&gt;</span>
      <span class="nv">n = </span><span class="nx">@length</span>
      <span class="nv">b = </span><span class="nx">$</span><span class="p">(</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">by</span> <span class="mi">2</span> <span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="o">is</span> <span class="mi">1</span>
        <span class="nx">b</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">@</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">undefined</span> <span class="p">)</span>
      <span class="nx">b</span>
    <span class="nv">flatten: </span><span class="o">-&gt;</span>
      <span class="nv">b = </span><span class="nx">$</span><span class="p">()</span>
      <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">j</span><span class="p">)</span> <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="nx">i</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@</span>
      <span class="nx">b</span>
    <span class="nv">call: </span><span class="o">-&gt;</span> <span class="nx">@apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
    <span class="nv">apply: </span><span class="nf">(context, args) -&gt;</span>
      <span class="nx">@filter</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;function&quot;</span><span class="p">,</span> <span class="nx">@</span><span class="p">).</span><span class="nx">map</span> <span class="o">-&gt;</span> <span class="nx">@apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="nv">log: </span><span class="nf">(label) -&gt;</span>
      <span class="k">if</span> <span class="nx">label</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">label</span><span class="p">,</span> <span class="nx">@toString</span><span class="p">(),</span> <span class="nx">@length</span> <span class="o">+</span> <span class="s">&quot; items&quot;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">@toString</span><span class="p">(),</span> <span class="nx">@length</span> <span class="o">+</span> <span class="s">&quot; items&quot;</span><span class="p">)</span>
      <span class="nx">@</span>
    <span class="nv">toArray: </span><span class="o">-&gt;</span>
      <span class="vi">@__proto__ = </span><span class="nb">Array</span><span class="o">::</span>
      <span class="nx">@</span> <span class="c1"># no copies, yay?</span>
  <span class="p">}</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&#39;date&#39;</span>
  <span class="nv">depends: </span><span class="s">&#39;type&#39;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="nx">ms</span><span class="p">,</span><span class="nx">s</span><span class="p">,</span><span class="nx">m</span><span class="p">,</span><span class="nx">h</span><span class="p">,</span><span class="nx">d</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">]</span>
  <span class="nv">units = </span><span class="p">{</span>
    <span class="nx">ms</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span>
    <span class="nv">sec: </span><span class="nx">s</span>
    <span class="nv">second: </span><span class="nx">s</span>
    <span class="nv">seconds: </span><span class="nx">s</span>
    <span class="nv">min: </span><span class="nx">m</span>
    <span class="nv">minute: </span><span class="nx">m</span>
    <span class="nv">minutes: </span><span class="nx">m</span>
    <span class="nv">hr: </span><span class="nx">h</span>
    <span class="nv">hour: </span><span class="nx">h</span>
    <span class="nv">hours: </span><span class="nx">h</span>
    <span class="nv">day: </span><span class="nx">d</span>
    <span class="nv">days: </span><span class="nx">d</span>
  <span class="p">}</span>
  <span class="nv">formats =</span>
    <span class="nv">yyyy: </span><span class="nb">Date</span><span class="o">::</span><span class="nx">getUTCFullYear</span>
    <span class="nv">mm: </span><span class="o">-&gt;</span> <span class="nx">@getUTCMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">dd: </span><span class="nb">Date</span><span class="o">::</span><span class="nx">getUTCDate</span>
    <span class="nv">HH: </span><span class="nb">Date</span><span class="o">::</span><span class="nx">getUTCHours</span>
    <span class="nv">MM: </span><span class="nb">Date</span><span class="o">::</span><span class="nx">getUTCMinutes</span>
    <span class="nv">SS: </span><span class="nb">Date</span><span class="o">::</span><span class="nx">getUTCSeconds</span>
    <span class="nv">MS: </span><span class="nb">Date</span><span class="o">::</span><span class="nx">getUTCMilliseconds</span>
  <span class="nv">format_keys = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">formats</span><span class="p">).</span><span class="nx">sort</span><span class="p">().</span><span class="nx">reverse</span><span class="p">()</span>
  <span class="nv">parsers =</span>
    <span class="nv">yyyy: </span><span class="nb">Date</span><span class="o">::</span><span class="nx">setUTCFullYear</span>
    <span class="nv">mm: </span><span class="nf">(x) -&gt;</span> <span class="nx">@setUTCMonth</span><span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nv">dd: </span><span class="nb">Date</span><span class="o">::</span><span class="nx">setUTCDate</span>
    <span class="nv">HH: </span><span class="nb">Date</span><span class="o">::</span><span class="nx">setUTCHours</span>
    <span class="nv">MM: </span><span class="nb">Date</span><span class="o">::</span><span class="nx">setUTCMinutes</span>
    <span class="nv">SS: </span><span class="nb">Date</span><span class="o">::</span><span class="nx">setUTCSeconds</span>
    <span class="nv">MS: </span><span class="nb">Date</span><span class="o">::</span><span class="nx">setUTCMilliseconds</span>
  <span class="nv">parser_keys = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">parsers</span><span class="p">).</span><span class="nx">sort</span><span class="p">().</span><span class="nx">reverse</span><span class="p">()</span>
  <span class="nv">floor = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">register</span> <span class="s">&quot;date&quot;</span><span class="p">,</span>
    <span class="nv">match: </span><span class="nf">(o) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isType</span> <span class="nb">Date</span><span class="p">,</span> <span class="nx">o</span>
    <span class="nv">array: </span><span class="nf">(o) -&gt;</span> <span class="p">[</span><span class="nx">o</span><span class="p">]</span>
    <span class="nv">string: </span><span class="nf">(o, fmt, unit) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">format</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">,</span> <span class="nx">unit</span>
    <span class="nv">number: </span><span class="nf">(o, unit) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">stamp</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">unit</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">extend</span> <span class="s">&#39;string&#39;</span><span class="p">,</span> <span class="nv">date: </span><span class="nf">(o, fmt = $.date.defaultFormat) -&gt;</span> <span class="k">new</span> <span class="nb">Date</span> <span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">,</span> <span class="s">&quot;ms&quot;</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">extend</span> <span class="s">&#39;number&#39;</span><span class="p">,</span> <span class="nv">date: </span><span class="nf">(o, unit) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">unstamp</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">unit</span>
  <span class="nv">adder = </span><span class="nf">(key) -&gt;</span>
    <span class="nf">(stamp, delta, stamp_unit = $.date.defaultUnit) -&gt;</span>
      <span class="nv">date = </span><span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">unstamp</span><span class="p">(</span><span class="nx">stamp</span><span class="p">,</span> <span class="nx">stamp_unit</span><span class="p">)</span>
      <span class="nx">parsers</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">call</span> <span class="nx">date</span><span class="p">,</span> <span class="p">(</span><span class="nx">formats</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">call</span> <span class="nx">date</span><span class="p">)</span> <span class="o">+</span> <span class="nx">delta</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">stamp</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">stamp_unit</span>
  <span class="nv">$:</span>
    <span class="nv">date:</span>
      <span class="nv">defaultUnit: </span><span class="s">&quot;s&quot;</span>
      <span class="nv">defaultFormat: </span><span class="s">&quot;yyyy-mm-dd HH:MM:SS&quot;</span>
      <span class="nv">stamp: </span><span class="nf">(date = new Date, unit = $.date.defaultUnit) -&gt;</span>
        <span class="nx">floor</span> <span class="p">(</span><span class="nx">date</span> <span class="o">/</span> <span class="nx">units</span><span class="p">[</span><span class="nx">unit</span><span class="p">])</span>
      <span class="nv">unstamp: </span><span class="nf">(stamp, unit = $.date.defaultUnit) -&gt;</span>
        <span class="k">new</span> <span class="nb">Date</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">stamp</span> <span class="o">*</span> <span class="nx">units</span><span class="p">[</span><span class="nx">unit</span><span class="p">])</span>
      <span class="nv">convert: </span><span class="nf">(stamp, from = $.date.defaultUnit, to = $.date.defaultUnit) -&gt;</span>
        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;date&quot;</span><span class="p">,</span> <span class="nx">stamp</span> <span class="k">then</span> <span class="nv">stamp = </span><span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">stamp</span><span class="p">(</span><span class="nx">stamp</span><span class="p">,</span> <span class="nx">from</span><span class="p">)</span>
        <span class="p">(</span><span class="nx">floor</span> <span class="nx">stamp</span> <span class="o">*</span> <span class="nx">units</span><span class="p">[</span><span class="nx">from</span><span class="p">]</span> <span class="o">/</span> <span class="nx">units</span><span class="p">[</span><span class="nx">to</span><span class="p">])</span>
      <span class="nv">midnight: </span><span class="nf">(stamp, unit = $.date.defaultUnit) -&gt;</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">convert</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">convert</span> <span class="nx">stamp</span><span class="p">,</span> <span class="nx">unit</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">),</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="nx">unit</span>
      <span class="nv">format: </span><span class="nf">(stamp, fmt = $.date.defaultFormat, unit = $.date.defaultUnit) -&gt;</span>
        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;date&quot;</span><span class="p">,</span> <span class="nx">stamp</span> <span class="k">then</span> <span class="nv">stamp = </span><span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">stamp</span><span class="p">(</span><span class="nx">stamp</span><span class="p">,</span> <span class="nx">unit</span><span class="p">)</span>
        <span class="nv">date = </span><span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">unstamp</span> <span class="nx">stamp</span><span class="p">,</span> <span class="nx">unit</span>
        <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">format_keys</span>
          <span class="nv">fmt = </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">k</span><span class="p">,</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">padLeft</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="nx">formats</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="nx">date</span><span class="p">),</span> <span class="nx">k</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">)</span>
        <span class="nx">fmt</span>
      <span class="nv">parse: </span><span class="nf">(dateString, fmt = $.date.defaultFormat, to = $.date.defaultUnit) -&gt;</span>
        <span class="nv">date = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
          <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">parser_keys</span>
            <span class="k">if</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">is</span> <span class="nx">i</span>
              <span class="k">try</span>
                <span class="nx">parsers</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">call</span> <span class="nx">date</span><span class="p">,</span>
                  <span class="nb">parseInt</span> <span class="nx">dateString</span><span class="p">[</span><span class="nx">i</span><span class="p">...</span><span class="nx">i</span><span class="o">+</span><span class="nx">k</span><span class="p">.</span><span class="nx">length</span><span class="p">],</span> <span class="mi">10</span>
              <span class="k">catch</span> <span class="nx">err</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;Invalid date (&#39;</span><span class="si">#{</span><span class="nx">dateString</span><span class="si">}</span><span class="s">&#39;) given format mask: </span><span class="si">#{</span><span class="nx">fmt</span><span class="si">}</span><span class="s"> (failed at position </span><span class="si">#{</span><span class="nx">i</span><span class="si">}</span><span class="s">)&quot;</span><span class="p">)</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">stamp</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">to</span>
      <span class="nv">addMilliseconds: </span><span class="nx">adder</span><span class="p">(</span><span class="s">&quot;MS&quot;</span><span class="p">)</span>
      <span class="nv">addSeconds: </span><span class="nx">adder</span><span class="p">(</span><span class="s">&quot;SS&quot;</span><span class="p">)</span>
      <span class="nv">addMinutes: </span><span class="nx">adder</span><span class="p">(</span><span class="s">&quot;MM&quot;</span><span class="p">)</span>
      <span class="nv">addHours: </span><span class="nx">adder</span><span class="p">(</span><span class="s">&quot;HH&quot;</span><span class="p">)</span>
      <span class="nv">addDays: </span><span class="nx">adder</span><span class="p">(</span><span class="s">&quot;dd&quot;</span><span class="p">)</span>
      <span class="nv">addMonths: </span><span class="nx">adder</span><span class="p">(</span><span class="s">&quot;mm&quot;</span><span class="p">)</span>
      <span class="nv">addYears: </span><span class="nx">adder</span><span class="p">(</span><span class="s">&quot;yyyy&quot;</span><span class="p">)</span>
      <span class="nv">range: </span><span class="nf">(from, to, interval=1, interval_unit=&quot;dd&quot;, stamp_unit = $.date.defaultUnit) -&gt;</span>
        <span class="nv">add = </span><span class="nx">adder</span><span class="p">(</span><span class="nx">interval_unit</span><span class="p">)</span>
        <span class="nv">ret = </span><span class="p">[</span><span class="nx">from</span><span class="p">]</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">cur = </span><span class="nx">ret</span><span class="p">[</span><span class="nx">ret</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nx">to</span>
          <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span> <span class="nx">add</span><span class="p">(</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">interval</span><span class="p">,</span> <span class="nx">stamp_unit</span><span class="p">)</span>
        <span class="nx">ret</span>
  <span class="nv">midnight: </span><span class="nf">(unit = $.date.defaultUnit) -&gt;</span> <span class="nx">@map</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">midnight</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">unit</span><span class="p">)</span>
  <span class="nv">unstamp: </span><span class="nf">(unit = $.date.defaultUnit) -&gt;</span> <span class="nx">@map</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">unstamp</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">unit</span><span class="p">)</span>
  <span class="nv">stamp: </span><span class="nf">(unit = $.date.defaultUnit) -&gt;</span> <span class="nx">@map</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">stamp</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">unit</span><span class="p">)</span>
  <span class="nv">dateFormat: </span><span class="nf">(fmt = $.date.defaultFormat, unit = $.date.defaultUnit) -&gt;</span> <span class="nx">@map</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">format</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">,</span> <span class="nx">unit</span><span class="p">)</span>
  <span class="nv">dateParse: </span><span class="nf">(fmt = $.date.defaultFormat, unit = $.date.defaultUnit) -&gt;</span> <span class="nx">@map</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">,</span> <span class="nx">unit</span><span class="p">)</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;delay&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;function&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">$:</span>
    <span class="nv">delay: </span><span class="p">(</span><span class="o">-&gt;</span>
      <span class="nv">timeoutQueue = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="p">[],</span> <span class="p">(</span><span class="o">-&gt;</span>
        <span class="nv">next = </span><span class="nf">(a) -&gt;</span> <span class="o">-&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shift</span><span class="p">()()</span> <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span>
        <span class="nv">add: </span><span class="nf">(f, n) -&gt;</span>
          <span class="nv">f.order = </span><span class="nx">n</span> <span class="o">+</span> <span class="nx">$</span><span class="p">.</span><span class="nx">now</span>
          <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">@length</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nx">i</span> <span class="o">is</span> <span class="nx">@length</span> <span class="o">or</span> <span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">order</span> <span class="o">&gt;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">order</span>
              <span class="nx">@splice</span> <span class="nx">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">f</span>
              <span class="k">break</span>
          <span class="nx">setTimeout</span> <span class="nx">next</span><span class="p">(</span><span class="nx">@</span><span class="p">),</span> <span class="nx">n</span>
          <span class="nx">@</span>
        <span class="nv">cancel: </span><span class="nf">(f) -&gt;</span>
          <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@length</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">f</span>
              <span class="nx">@splice</span> <span class="nx">i</span><span class="p">,</span> <span class="mi">1</span>
              <span class="k">break</span>
          <span class="nx">@</span>
      <span class="p">)()</span>
      <span class="nf">(n, f) -&gt;</span>
        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;function&quot;</span><span class="p">,</span><span class="nx">f</span><span class="p">)</span> <span class="k">then</span> <span class="nx">timeoutQueue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
        <span class="nv">cancel: </span><span class="o">-&gt;</span> <span class="nx">timeoutQueue</span><span class="p">.</span><span class="nx">cancel</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
    <span class="p">)()</span>
  <span class="nv">delay: </span><span class="nf">(n, f, c=@) -&gt;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">delay</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">bound</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span>
    <span class="nx">@</span>
  <span class="nv">interval: </span><span class="nf">(n, f, c=@) -&gt;</span>
    <span class="nv">g = </span><span class="nx">$</span><span class="p">.</span><span class="nx">bound</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">f</span>
    <span class="nv">h = </span><span class="o">-&gt;</span> <span class="nx">g</span><span class="p">();</span> <span class="nx">$</span><span class="p">.</span><span class="nx">delay</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">h</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">delay</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">h</span>
    <span class="nx">@</span>
<span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">global</span><span class="p">.</span><span class="nb">document</span><span class="o">?</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
    <span class="nv">depends: </span><span class="s">&quot;function,type&quot;</span>
    <span class="nv">provides: </span><span class="s">&quot;dom&quot;</span>
  <span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">register</span> <span class="s">&quot;nodelist&quot;</span><span class="p">,</span>
      <span class="nv">match: </span> <span class="nf">(o) -&gt;</span> <span class="nx">o</span><span class="o">?</span> <span class="o">and</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isType</span> <span class="s">&quot;NodeList&quot;</span><span class="p">,</span> <span class="nx">o</span>
      <span class="nv">hash: </span>  <span class="nf">(o) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">x</span><span class="p">).</span><span class="nx">sum</span><span class="p">()</span>
      <span class="nv">array: </span> <span class="nx">$</span><span class="p">.</span><span class="nx">identity</span>
      <span class="nv">string: </span><span class="nf">(o) -&gt;</span> <span class="s">&quot;{Nodelist:[&quot;</span><span class="o">+</span><span class="nx">$</span><span class="p">(</span><span class="nx">o</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="s">&#39;nodeName&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;]}&quot;</span>
      <span class="nv">node: </span>  <span class="nf">(o) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">o</span><span class="p">).</span><span class="nx">toFragment</span><span class="p">()</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">register</span> <span class="s">&quot;node&quot;</span><span class="p">,</span>
      <span class="nv">match: </span> <span class="nf">(o) -&gt;</span> <span class="nx">o</span><span class="o">?</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">hash: </span>  <span class="nf">(o) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">checksum</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">)</span> <span class="o">+</span> <span class="nx">$</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span> <span class="o">+</span> <span class="nx">$</span><span class="p">.</span><span class="nx">checksum</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">)</span>
      <span class="nv">string: </span><span class="nf">(o) -&gt;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
      <span class="nv">node: </span>  <span class="nx">$</span><span class="p">.</span><span class="nx">identity</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">register</span> <span class="s">&quot;fragment&quot;</span><span class="p">,</span>
      <span class="nv">match: </span> <span class="nf">(o) -&gt;</span> <span class="nx">o</span><span class="o">?</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">is</span> <span class="mi">11</span>
      <span class="nv">hash: </span>  <span class="nf">(o) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">o</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">).</span><span class="nx">sum</span><span class="p">()</span>
      <span class="nv">string: </span><span class="nf">(o) -&gt;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
      <span class="nv">node: </span>  <span class="nx">$</span><span class="p">.</span><span class="nx">identity</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">register</span> <span class="s">&quot;html&quot;</span><span class="p">,</span>
      <span class="nv">match: </span> <span class="nf">(o) -&gt;</span> <span class="k">typeof</span> <span class="nx">o</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span> <span class="o">and</span> <span class="p">(</span><span class="nx">s</span><span class="o">=</span><span class="nx">o</span><span class="p">.</span><span class="nx">trimLeft</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&lt;&quot;</span> <span class="o">and</span> <span class="nx">s</span><span class="p">[</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&gt;&quot;</span>
      <span class="nv">node: </span>  <span class="nf">(h) -&gt;</span>
        <span class="p">(</span><span class="nv">node = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nv">innerHTML = </span><span class="nx">h</span>
        <span class="k">if</span> <span class="nv">n = </span><span class="p">(</span><span class="nv">childNodes = </span><span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">).</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
          <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nv">df = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">()</span>
        <span class="nx">df</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">n</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
        <span class="nx">df</span>
      <span class="nv">array: </span> <span class="nf">(o) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nv">h = </span><span class="nx">Bling</span><span class="p">.</span><span class="nx">HTML</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">o</span><span class="p">).</span><span class="nx">array</span> <span class="nx">h</span>
      <span class="nv">string: </span><span class="nf">(o) -&gt;</span> <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">o</span><span class="si">}</span><span class="s">&#39;&quot;</span>
      <span class="nv">repr: </span>  <span class="nf">(o) -&gt;</span> <span class="s">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nx">o</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">extend</span>
      <span class="nv">unknown: </span> <span class="p">{</span> <span class="nv">node: </span><span class="o">-&gt;</span> <span class="kc">null</span> <span class="p">}</span>
      <span class="nv">bling: </span>   <span class="p">{</span> <span class="nv">node: </span><span class="nf">(o) -&gt;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">toFragment</span><span class="p">()</span> <span class="p">}</span>
      <span class="nv">node: </span>    <span class="p">{</span> <span class="nv">html: </span><span class="nf">(n) -&gt;</span>
        <span class="nv">d = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s">&quot;div&quot;</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">appendChild</span> <span class="p">(</span><span class="nv">n = </span><span class="nx">n</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">true</span><span class="p">)</span>
        <span class="nv">ret = </span><span class="nx">d</span><span class="p">.</span><span class="nx">innerHTML</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">n</span> <span class="c1"># break links to prevent leaks</span>
        <span class="nx">ret</span>
      <span class="p">}</span>
      <span class="nv">string:</span>
        <span class="nv">node: </span> <span class="nf">(o) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">o</span><span class="p">).</span><span class="nx">toFragment</span><span class="p">()</span>
        <span class="nv">array: </span><span class="nf">(o) -&gt;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="o">?</span> <span class="nx">o</span>
      <span class="nv">function: </span><span class="p">{</span> <span class="nv">node: </span><span class="nf">(o) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">toString</span><span class="p">()).</span><span class="nx">toFragment</span><span class="p">()</span> <span class="p">}</span>
    <span class="nv">toFrag = </span><span class="nf">(a) -&gt;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">a</span><span class="p">.</span><span class="nx">parentNode</span><span class="o">?</span>
        <span class="nv">df = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">()</span>
        <span class="nx">df</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">a</span>
      <span class="nx">a</span>
    <span class="nv">before = </span><span class="nf">(a,b) -&gt;</span> <span class="nx">toFrag</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span>
    <span class="nv">after = </span><span class="nf">(a,b) -&gt;</span> <span class="nx">toFrag</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">nextSibling</span>
    <span class="nv">toNode = </span><span class="nf">(x) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">node</span> <span class="nx">x</span>
    <span class="nv">escaper = </span><span class="kc">false</span>
    <span class="nv">parser = </span><span class="kc">false</span>
    <span class="nv">computeCSSProperty = </span><span class="nf">(k) -&gt;</span> <span class="o">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">global</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="nx">getPropertyValue</span> <span class="nx">k</span>
    <span class="nv">getOrSetRect = </span><span class="nf">(p) -&gt;</span> <span class="nf">(x) -&gt;</span> <span class="k">if</span> <span class="nx">x</span><span class="o">?</span> <span class="k">then</span> <span class="nx">@css</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="k">else</span> <span class="nx">@rect</span><span class="p">().</span><span class="nx">select</span> <span class="nx">p</span>
    <span class="nv">selectChain = </span><span class="nf">(prop) -&gt;</span> <span class="o">-&gt;</span> <span class="nx">@map</span> <span class="nf">(p) -&gt;</span> <span class="nx">$</span><span class="p">(</span> <span class="nx">p</span> <span class="k">while</span> <span class="nv">p = </span><span class="nx">p</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nv">$:</span>
        <span class="nv">HTML:</span>
          <span class="nv">parse: </span><span class="nf">(h) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">h</span><span class="p">).</span><span class="nx">node</span> <span class="nx">h</span>
          <span class="nv">stringify: </span><span class="nf">(n) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">html</span> <span class="nx">n</span>
          <span class="nv">escape: </span><span class="nf">(h) -&gt;</span>
            <span class="nx">escaper</span> <span class="o">or=</span> <span class="nx">$</span><span class="p">(</span><span class="s">&quot;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&quot;</span><span class="p">).</span><span class="nx">child</span> <span class="mi">0</span>
            <span class="nv">ret = </span><span class="nx">escaper</span><span class="p">.</span><span class="nx">zap</span><span class="p">(</span><span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="nx">h</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="s">&quot;parentNode.innerHTML&quot;</span><span class="p">).</span><span class="nx">first</span><span class="p">()</span>
            <span class="nx">escaper</span><span class="p">.</span><span class="nx">zap</span><span class="p">(</span><span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="nx">ret</span>
      <span class="nv">html: </span><span class="nf">(h) -&gt;</span>
        <span class="k">return</span> <span class="k">switch</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span> <span class="nx">h</span>
          <span class="k">when</span> <span class="s">&quot;undefined&quot;</span><span class="p">,</span><span class="s">&quot;null&quot;</span> <span class="k">then</span> <span class="nx">@select</span> <span class="s">&#39;innerHTML&#39;</span>
          <span class="k">when</span> <span class="s">&quot;string&quot;</span><span class="p">,</span><span class="s">&quot;html&quot;</span> <span class="k">then</span> <span class="nx">@zap</span> <span class="s">&#39;innerHTML&#39;</span><span class="p">,</span> <span class="nx">h</span>
          <span class="k">when</span> <span class="s">&quot;bling&quot;</span> <span class="k">then</span> <span class="nx">@html</span> <span class="nx">h</span><span class="p">.</span><span class="nx">toFragment</span><span class="p">()</span>
          <span class="k">when</span> <span class="s">&quot;node&quot;</span>
            <span class="nx">@each</span> <span class="o">-&gt;</span> <span class="c1"># replace all our children with the new child</span>
              <span class="nx">@replaceChild</span> <span class="nx">@childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">h</span>
              <span class="k">while</span> <span class="nx">@childNodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="nx">@removeChild</span> <span class="nx">@childNodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">append: </span><span class="nf">(x) -&gt;</span> <span class="c1"># .append(/n/) - insert /n/ [or a clone] as the last child of each node</span>
        <span class="nv">x = </span><span class="nx">toNode</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="c1"># parse, cast, do whatever it takes to get a Node or Fragment</span>
        <span class="nx">@each</span> <span class="o">-&gt;</span> <span class="nx">@appendChild</span> <span class="nx">x</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">true</span>
      <span class="nv">appendTo: </span><span class="nf">(x) -&gt;</span> <span class="c1"># .appendTo(/n/) - each node [or fragment] will become the last child of x</span>
        <span class="nv">clones = </span><span class="nx">@map</span><span class="p">(</span> <span class="o">-&gt;</span> <span class="nx">@cloneNode</span> <span class="kc">true</span><span class="p">)</span>
        <span class="nv">i = </span><span class="mi">0</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">each</span> <span class="o">-&gt;</span> <span class="nx">@appendChild</span> <span class="nx">clones</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span>
        <span class="nx">clones</span>
      <span class="nv">prepend: </span><span class="nf">(x) -&gt;</span> <span class="c1"># .prepend(/n/) - insert n [or a clone] as the first child of each node</span>
        <span class="k">if</span> <span class="nx">x</span><span class="o">?</span>
          <span class="nv">x = </span><span class="nx">toNode</span> <span class="nx">x</span>
          <span class="nx">@take</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">each</span> <span class="o">-&gt;</span>
            <span class="nx">before</span> <span class="nx">@childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x</span>
          <span class="nx">@skip</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">each</span> <span class="o">-&gt;</span>
            <span class="nx">before</span> <span class="nx">@childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">true</span>
        <span class="nx">@</span>
      <span class="nv">prependTo: </span><span class="nf">(x) -&gt;</span> <span class="c1"># .prependTo(/n/) - each node [or a fragment] will become the first child of x</span>
        <span class="k">if</span> <span class="nx">x</span><span class="o">?</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
        <span class="nx">@</span>
      <span class="nv">before: </span><span class="nf">(x) -&gt;</span> <span class="c1"># .before(/x/) - insert content x before each node</span>
        <span class="k">if</span> <span class="nx">x</span><span class="o">?</span>
          <span class="nv">x = </span><span class="nx">toNode</span> <span class="nx">x</span>
          <span class="nx">@take</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">each</span> <span class="o">-&gt;</span> <span class="nx">before</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">x</span>
          <span class="nx">@skip</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">each</span> <span class="o">-&gt;</span> <span class="nx">before</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">x</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">true</span>
        <span class="nx">@</span>
      <span class="nv">after: </span><span class="nf">(x) -&gt;</span> <span class="c1"># .after(/n/) - insert content n after each node</span>
        <span class="k">if</span> <span class="nx">x</span><span class="o">?</span>
          <span class="nv">x = </span><span class="nx">toNode</span> <span class="nx">x</span>
          <span class="nx">@take</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">each</span> <span class="o">-&gt;</span> <span class="nx">after</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">x</span>
          <span class="nx">@skip</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">each</span> <span class="o">-&gt;</span> <span class="nx">after</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">x</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">true</span>
        <span class="nx">@</span>
      <span class="nv">wrap: </span><span class="nf">(parent) -&gt;</span> <span class="c1"># .wrap(/parent/) - parent becomes the new .parentNode of each node</span>
        <span class="nv">parent = </span><span class="nx">toNode</span> <span class="nx">parent</span>
        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;fragment&quot;</span><span class="p">,</span> <span class="nx">parent</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;cannot call .wrap() with a fragment as the parent&quot;</span><span class="p">)</span>
        <span class="nx">@each</span> <span class="nf">(child) -&gt;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;fragment&quot;</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">child</span><span class="p">.</span><span class="nx">parentNode</span>
            <span class="k">return</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">child</span>
          <span class="nv">grandpa = </span><span class="nx">child</span><span class="p">.</span><span class="nx">parentNode</span>
          <span class="nv">marker = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s">&quot;dummy&quot;</span>
          <span class="nx">parent</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">grandpa</span><span class="p">.</span><span class="nx">replaceChild</span> <span class="nx">marker</span><span class="p">,</span> <span class="nx">child</span>
          <span class="nx">grandpa</span><span class="p">.</span><span class="nx">replaceChild</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">marker</span>
      <span class="nv">unwrap: </span><span class="o">-&gt;</span> <span class="c1"># .unwrap() - replace each node&#39;s parent with itself</span>
        <span class="nx">@each</span> <span class="o">-&gt;</span>
          <span class="k">if</span> <span class="nx">@parentNode</span> <span class="o">and</span> <span class="nx">@parentNode</span><span class="p">.</span><span class="nx">parentNode</span>
            <span class="nx">@parentNode</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="nx">@parentNode</span><span class="p">)</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">@parentNode</span>
            <span class="nx">@parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
      <span class="nv">replace: </span><span class="nf">(n) -&gt;</span> <span class="c1"># .replace(/n/) - replace each node with n [or a clone]</span>
        <span class="nv">n = </span><span class="nx">toNode</span> <span class="nx">n</span>
        <span class="nv">clones = </span><span class="nx">@map</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">true</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">clones</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
          <span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">parentNode</span><span class="o">?</span><span class="p">.</span><span class="nx">replaceChild</span> <span class="nx">clones</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="nx">clones</span>
      <span class="nv">attr: </span><span class="nf">(a,v) -&gt;</span> <span class="c1"># .attr(a, [v]) - get [or set] an /a/ttribute [/v/alue]</span>
        <span class="k">return</span> <span class="k">switch</span> <span class="nx">v</span>
          <span class="k">when</span> <span class="kc">undefined</span> <span class="k">then</span> <span class="nx">@select</span><span class="p">(</span><span class="s">&quot;getAttribute&quot;</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
          <span class="k">when</span> <span class="kc">null</span> <span class="k">then</span> <span class="nx">@select</span><span class="p">(</span><span class="s">&quot;removeAttribute&quot;</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="nx">@select</span><span class="p">(</span><span class="s">&quot;setAttribute&quot;</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
            <span class="nx">@</span>
      <span class="nv">data: </span><span class="nf">(k, v) -&gt;</span> <span class="nx">@attr</span> <span class="s">&quot;data-</span><span class="si">#{</span><span class="nx">$</span><span class="p">.</span><span class="nx">dashize</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">v</span>
      <span class="nv">addClass: </span><span class="nf">(x) -&gt;</span> <span class="c1"># .addClass(/x/) - add x to each node&#39;s .className</span>
        <span class="nv">notempty = </span><span class="nf">(y) -&gt;</span> <span class="nx">y</span> <span class="o">isnt</span> <span class="s">&quot;&quot;</span>
        <span class="nx">@removeClass</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">each</span> <span class="o">-&gt;</span>
          <span class="nv">c = </span><span class="nx">@className</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">).</span><span class="nx">filter</span> <span class="nx">notempty</span>
          <span class="nx">c</span><span class="p">.</span><span class="nx">push</span> <span class="nx">x</span>
          <span class="vi">@className = </span><span class="nx">c</span><span class="p">.</span><span class="nx">join</span> <span class="s">&quot; &quot;</span>
      <span class="nv">removeClass: </span><span class="nf">(x) -&gt;</span> <span class="c1"># .removeClass(/x/) - remove class x from each node&#39;s .className</span>
        <span class="nv">notx = </span><span class="nf">(y) -&gt;</span> <span class="nx">y</span> <span class="o">!=</span> <span class="nx">x</span>
        <span class="nx">@each</span> <span class="o">-&gt;</span>
          <span class="nv">c = </span><span class="nx">@className</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">notx</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
            <span class="nx">@removeAttribute</span><span class="p">(</span><span class="s">&#39;class&#39;</span><span class="p">)</span>
      <span class="nv">toggleClass: </span><span class="nf">(x) -&gt;</span> <span class="c1"># .toggleClass(/x/) - add, or remove if present, class x from each node</span>
        <span class="nv">notx = </span><span class="nf">(y) -&gt;</span> <span class="nx">y</span> <span class="o">isnt</span> <span class="nx">x</span>
        <span class="nx">@each</span> <span class="o">-&gt;</span>
          <span class="nv">cls = </span><span class="nx">@className</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
          <span class="nv">filter = </span><span class="nx">$</span><span class="p">.</span><span class="o">not</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isEmpty</span>
          <span class="k">if</span><span class="p">(</span> <span class="nx">cls</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
            <span class="nv">filter = </span><span class="nx">$</span><span class="p">.</span><span class="o">and</span> <span class="nx">notx</span><span class="p">,</span> <span class="nx">filter</span>
          <span class="k">else</span>
            <span class="nx">cls</span><span class="p">.</span><span class="nx">push</span> <span class="nx">x</span>
          <span class="nv">c = </span><span class="nx">cls</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">filter</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
          <span class="vi">@className = </span><span class="nx">c</span>
          <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
            <span class="nx">@removeAttribute</span><span class="p">(</span><span class="s">&#39;class&#39;</span><span class="p">)</span>
      <span class="nv">hasClass: </span><span class="nf">(x) -&gt;</span> <span class="c1"># .hasClass(/x/) - true/false for each node: whether .className contains x</span>
        <span class="nx">@select</span><span class="p">(</span><span class="s">&#39;className.split&#39;</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="s">&#39;indexOf&#39;</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">map</span> <span class="nf">(x) -&gt;</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
      <span class="nv">text: </span><span class="nf">(t) -&gt;</span> <span class="c1"># .text([t]) - get [or set] each node&#39;s .textContent</span>
        <span class="k">return</span> <span class="nx">@zap</span><span class="p">(</span><span class="s">&#39;textContent&#39;</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="k">if</span> <span class="nx">t</span><span class="o">?</span>
        <span class="k">return</span> <span class="nx">@select</span><span class="p">(</span><span class="s">&#39;textContent&#39;</span><span class="p">)</span>
      <span class="nv">val: </span><span class="nf">(v) -&gt;</span> <span class="c1"># .val([v]) - get [or set] each node&#39;s .value</span>
        <span class="k">return</span> <span class="nx">@zap</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="k">if</span> <span class="nx">v</span><span class="o">?</span>
        <span class="k">return</span> <span class="nx">@select</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">)</span>
      <span class="nv">css: </span><span class="nf">(k,v) -&gt;</span>
        <span class="k">if</span> <span class="nx">v</span><span class="o">?</span> <span class="o">or</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;object&quot;</span><span class="p">,</span> <span class="nx">k</span>
          <span class="nv">setter = </span><span class="nx">@select</span> <span class="s">&#39;style.setProperty&#39;</span>
          <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;object&quot;</span><span class="p">,</span> <span class="nx">k</span> <span class="k">then</span> <span class="nx">setter</span><span class="p">.</span><span class="nx">call</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">k</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="s">&quot;&quot;</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">of</span> <span class="nx">k</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="nx">v</span> <span class="k">then</span> <span class="nx">setter</span><span class="p">.</span><span class="nx">call</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="s">&quot;&quot;</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;array&quot;</span><span class="p">,</span> <span class="nx">v</span>
            <span class="nx">setter</span><span class="p">[</span><span class="nx">i</span><span class="o">%</span><span class="nx">nn</span><span class="p">]</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">[</span><span class="nx">i</span><span class="o">%</span><span class="nx">n</span><span class="p">],</span> <span class="s">&quot;&quot;</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nv">n = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="nx">v</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nv">nn = </span><span class="nx">setter</span><span class="p">.</span><span class="nx">len</span><span class="p">()]</span> <span class="k">by</span> <span class="mi">1</span>
          <span class="k">return</span> <span class="nx">@</span>
        <span class="k">else</span>
          <span class="nv">cv = </span><span class="nx">@map</span> <span class="nx">computeCSSProperty</span> <span class="nx">k</span>
          <span class="nv">ov = </span><span class="nx">@select</span><span class="p">(</span><span class="s">&#39;style&#39;</span><span class="p">).</span><span class="nx">select</span> <span class="nx">k</span>
          <span class="nx">ov</span><span class="p">.</span><span class="nx">weave</span><span class="p">(</span><span class="nx">cv</span><span class="p">).</span><span class="nx">fold</span> <span class="nf">(x,y) -&gt;</span> <span class="nx">x</span> <span class="o">or</span> <span class="nx">y</span>
      <span class="nv">defaultCss: </span><span class="nf">(k, v) -&gt;</span>
        <span class="nv">sel = </span><span class="nx">@selector</span>
        <span class="nv">style = </span><span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="nx">k</span>
          <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="nx">v</span>
            <span class="nx">style</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">sel</span><span class="si">}</span><span class="s"> { </span><span class="si">#{</span><span class="nx">k</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">v</span><span class="si">}</span><span class="s"> } &quot;</span>
          <span class="k">else</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;defaultCss requires a value with a string key&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;object&quot;</span><span class="p">,</span> <span class="nx">k</span>
          <span class="nx">style</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">sel</span><span class="si">}</span><span class="s"> { &quot;</span> <span class="o">+</span>
            <span class="s">&quot;</span><span class="si">#{</span><span class="nx">i</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">k</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="si">}</span><span class="s">; &quot;</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">of</span> <span class="nx">k</span> <span class="o">+</span>
          <span class="s">&quot;} &quot;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s">&quot;&lt;style&gt;&lt;/style&gt;&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">style</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="s">&quot;head&quot;</span><span class="p">)</span>
        <span class="nx">@</span>
      <span class="nv">rect: </span><span class="o">-&gt;</span> <span class="nx">@select</span><span class="p">(</span><span class="s">&#39;getBoundingClientRect&#39;</span><span class="p">).</span><span class="nx">call</span><span class="p">()</span>
      <span class="nv">width: </span><span class="nx">getOrSetRect</span><span class="p">(</span><span class="s">&quot;width&quot;</span><span class="p">)</span>
      <span class="nv">height: </span><span class="nx">getOrSetRect</span><span class="p">(</span><span class="s">&quot;height&quot;</span><span class="p">)</span>
      <span class="nv">top: </span><span class="nx">getOrSetRect</span><span class="p">(</span><span class="s">&quot;top&quot;</span><span class="p">)</span>
      <span class="nv">left: </span><span class="nx">getOrSetRect</span><span class="p">(</span><span class="s">&quot;left&quot;</span><span class="p">)</span>
      <span class="nv">bottom: </span><span class="nx">getOrSetRect</span><span class="p">(</span><span class="s">&quot;bottom&quot;</span><span class="p">)</span>
      <span class="nv">right: </span><span class="nx">getOrSetRect</span><span class="p">(</span><span class="s">&quot;right&quot;</span><span class="p">)</span>
      <span class="nv">position: </span><span class="nf">(left, top) -&gt;</span>
        <span class="k">switch</span> <span class="kc">true</span>
          <span class="k">when</span> <span class="o">not</span> <span class="nx">left</span><span class="o">?</span> <span class="k">then</span> <span class="nx">@rect</span><span class="p">()</span>
          <span class="k">when</span> <span class="o">not</span> <span class="nx">top</span><span class="o">?</span> <span class="k">then</span> <span class="nx">@css</span><span class="p">(</span><span class="s">&quot;left&quot;</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">px</span><span class="p">(</span><span class="nx">left</span><span class="p">))</span>
          <span class="k">else</span> <span class="nx">@css</span><span class="p">({</span><span class="nv">top: </span><span class="nx">$</span><span class="p">.</span><span class="nx">px</span><span class="p">(</span><span class="nx">top</span><span class="p">),</span> <span class="nv">left: </span><span class="nx">$</span><span class="p">.</span><span class="nx">px</span><span class="p">(</span><span class="nx">left</span><span class="p">)})</span>
      <span class="nv">scrollToCenter: </span><span class="o">-&gt;</span>
        <span class="nb">document</span><span class="p">.</span><span class="nv">body.scrollTop = </span><span class="nx">@</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">offsetTop</span> <span class="o">-</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">global</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="nx">@</span>
      <span class="nv">child: </span><span class="nf">(n) -&gt;</span> <span class="nx">@select</span><span class="p">(</span><span class="s">&#39;childNodes&#39;</span><span class="p">).</span><span class="nx">map</span> <span class="o">-&gt;</span> <span class="nx">@</span><span class="p">[</span> <span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="p">(</span><span class="nx">n</span><span class="o">+</span><span class="nx">@length</span><span class="p">)</span> <span class="k">else</span> <span class="nx">n</span> <span class="p">]</span>
      <span class="nv">parents: </span><span class="nx">selectChain</span><span class="p">(</span><span class="s">&#39;parentNode&#39;</span><span class="p">)</span>
      <span class="nv">prev: </span><span class="nx">selectChain</span><span class="p">(</span><span class="s">&#39;previousSibling&#39;</span><span class="p">)</span>
      <span class="nv">next: </span><span class="nx">selectChain</span><span class="p">(</span><span class="s">&#39;nextSibling&#39;</span><span class="p">)</span>
      <span class="nv">remove: </span><span class="o">-&gt;</span> <span class="nx">@each</span> <span class="o">-&gt;</span> <span class="nx">@parentNode</span><span class="o">?</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
      <span class="nv">find: </span><span class="nf">(css) -&gt;</span>
        <span class="nx">@filter</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="o">-&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">css</span><span class="p">,</span> <span class="nx">@</span><span class="p">)</span> <span class="p">)</span>
          <span class="p">.</span><span class="nx">flatten</span><span class="p">()</span>
      <span class="nv">clone: </span><span class="nf">(deep=true) -&gt;</span> <span class="nx">@map</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nx">@cloneNode</span> <span class="nx">deep</span><span class="p">)</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;node&quot;</span><span class="p">,</span> <span class="nx">@</span>
      <span class="nv">toFragment: </span><span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">@length</span> <span class="o">&gt;</span> <span class="mi">1</span>
          <span class="nv">df = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">()</span>
          <span class="p">(</span><span class="nx">@map</span> <span class="nx">toNode</span><span class="p">).</span><span class="nx">map</span> <span class="nx">$</span><span class="p">.</span><span class="nx">bound</span> <span class="nx">df</span><span class="p">,</span> <span class="nx">df</span><span class="p">.</span><span class="nx">appendChild</span>
          <span class="k">return</span> <span class="nx">df</span>
        <span class="k">return</span> <span class="nx">toNode</span> <span class="nx">@</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">}</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">depends: </span><span class="s">&quot;dom,function,core&quot;</span>
  <span class="nv">provides: </span><span class="s">&quot;event&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">EVENTSEP_RE = </span><span class="sr">/,* +/</span>
  <span class="nv">events = </span><span class="p">[</span><span class="s">&#39;mousemove&#39;</span><span class="p">,</span><span class="s">&#39;mousedown&#39;</span><span class="p">,</span><span class="s">&#39;mouseup&#39;</span><span class="p">,</span><span class="s">&#39;mouseover&#39;</span><span class="p">,</span><span class="s">&#39;mouseout&#39;</span><span class="p">,</span><span class="s">&#39;blur&#39;</span><span class="p">,</span><span class="s">&#39;focus&#39;</span><span class="p">,</span>
    <span class="s">&#39;load&#39;</span><span class="p">,</span><span class="s">&#39;unload&#39;</span><span class="p">,</span><span class="s">&#39;reset&#39;</span><span class="p">,</span><span class="s">&#39;submit&#39;</span><span class="p">,</span><span class="s">&#39;keyup&#39;</span><span class="p">,</span><span class="s">&#39;keydown&#39;</span><span class="p">,</span><span class="s">&#39;change&#39;</span><span class="p">,</span>
    <span class="s">&#39;abort&#39;</span><span class="p">,</span><span class="s">&#39;cut&#39;</span><span class="p">,</span><span class="s">&#39;copy&#39;</span><span class="p">,</span><span class="s">&#39;paste&#39;</span><span class="p">,</span><span class="s">&#39;selection&#39;</span><span class="p">,</span><span class="s">&#39;drag&#39;</span><span class="p">,</span><span class="s">&#39;drop&#39;</span><span class="p">,</span><span class="s">&#39;orientationchange&#39;</span><span class="p">,</span>
    <span class="s">&#39;touchstart&#39;</span><span class="p">,</span><span class="s">&#39;touchmove&#39;</span><span class="p">,</span><span class="s">&#39;touchend&#39;</span><span class="p">,</span><span class="s">&#39;touchcancel&#39;</span><span class="p">,</span>
    <span class="s">&#39;gesturestart&#39;</span><span class="p">,</span><span class="s">&#39;gestureend&#39;</span><span class="p">,</span><span class="s">&#39;gesturecancel&#39;</span><span class="p">,</span>
    <span class="s">&#39;hashchange&#39;</span>
  <span class="p">]</span>
  <span class="nv">binder = </span><span class="nf">(e) -&gt;</span> <span class="nf">(f) -&gt;</span> <span class="nx">@bind</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;function&quot;</span><span class="p">,</span> <span class="nx">f</span> <span class="k">else</span> <span class="nx">@trigger</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span>
  <span class="nv">register_live = </span><span class="nf">(selector, context, evt, f, h) -&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">context</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">each</span> <span class="o">-&gt;</span> <span class="p">(((</span><span class="nx">@__alive__</span> <span class="o">or=</span> <span class="p">{})[</span><span class="nx">selector</span><span class="p">]</span> <span class="o">or=</span> <span class="p">{})[</span><span class="nx">evt</span><span class="p">]</span> <span class="o">or=</span> <span class="p">{})[</span><span class="nx">f</span><span class="p">]</span> <span class="o">=</span> <span class="nx">h</span>
  <span class="nv">unregister_live = </span><span class="nf">(selector, context, e, f) -&gt;</span>
    <span class="nv">$c = </span><span class="nx">$</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
    <span class="nx">$c</span><span class="p">.</span><span class="nx">each</span> <span class="o">-&gt;</span>
      <span class="nv">a = </span><span class="p">(</span><span class="nx">@__alive__</span> <span class="o">or=</span> <span class="p">{})</span>
      <span class="nv">b = </span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">selector</span><span class="p">]</span> <span class="o">or=</span> <span class="p">{})</span>
      <span class="nv">c = </span><span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="nx">e</span><span class="p">]</span> <span class="o">or=</span> <span class="p">{})</span>
      <span class="nx">$c</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">c</span><span class="p">[</span><span class="nx">f</span><span class="p">])</span>
      <span class="k">delete</span> <span class="nx">c</span><span class="p">[</span><span class="nx">f</span><span class="p">]</span>
  <span class="nv">triggerReady = </span><span class="nx">$</span><span class="p">.</span><span class="nx">once</span> <span class="o">-&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s">&quot;ready&quot;</span><span class="p">).</span><span class="nx">unbind</span><span class="p">(</span><span class="s">&quot;ready&quot;</span><span class="p">)</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="o">?</span><span class="p">(</span><span class="s">&quot;DOMContentLoaded&quot;</span><span class="p">,</span> <span class="nx">triggerReady</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">global</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="o">?</span><span class="p">(</span><span class="s">&quot;load&quot;</span><span class="p">,</span> <span class="nx">triggerReady</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
  <span class="nv">bindReady = </span><span class="nx">$</span><span class="p">.</span><span class="nx">once</span> <span class="o">-&gt;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="o">?</span><span class="p">(</span><span class="s">&quot;DOMContentLoaded&quot;</span><span class="p">,</span> <span class="nx">triggerReady</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">global</span><span class="p">.</span><span class="nx">addEventListener</span><span class="o">?</span><span class="p">(</span><span class="s">&quot;load&quot;</span><span class="p">,</span> <span class="nx">triggerReady</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
  <span class="nx">bindReady</span><span class="p">()</span>
  <span class="nv">ret = </span><span class="p">{</span>
    <span class="nv">bind: </span><span class="nf">(e, f) -&gt;</span>
      <span class="nv">c = </span><span class="p">(</span><span class="nx">e</span> <span class="o">or</span> <span class="s">&quot;&quot;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="nx">EVENTSEP_RE</span><span class="p">)</span>
      <span class="nv">h = </span><span class="nf">(evt) -&gt;</span>
        <span class="nv">ret = </span><span class="nx">f</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">arguments</span>
        <span class="k">if</span> <span class="nx">ret</span> <span class="o">is</span> <span class="kc">false</span>
          <span class="nx">evt</span><span class="p">.</span><span class="nx">preventAll</span><span class="p">()</span>
        <span class="nx">ret</span>
      <span class="nx">@each</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nx">@addEventListener</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">c</span>
    <span class="nv">unbind: </span><span class="nf">(e, f) -&gt;</span>
      <span class="nv">c = </span><span class="p">(</span><span class="nx">e</span> <span class="o">or</span> <span class="s">&quot;&quot;</span><span class="p">).</span><span class="nx">split</span> <span class="nx">EVENTSEP_RE</span>
      <span class="nx">@each</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nx">@removeEventListener</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">c</span>
    <span class="nv">trigger: </span><span class="nf">(evt, args = {}) -&gt;</span>
      <span class="nv">args = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span>
        <span class="nv">bubbles: </span><span class="kc">true</span>
        <span class="nv">cancelable: </span><span class="kc">true</span>
      <span class="p">,</span> <span class="nx">args</span>
      <span class="k">for</span> <span class="nx">evt_i</span> <span class="k">in</span> <span class="p">(</span><span class="nx">evt</span> <span class="o">or</span> <span class="s">&quot;&quot;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="nx">EVENTSEP_RE</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">evt_i</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;click&quot;</span><span class="p">,</span> <span class="s">&quot;mousemove&quot;</span><span class="p">,</span> <span class="s">&quot;mousedown&quot;</span><span class="p">,</span> <span class="s">&quot;mouseup&quot;</span><span class="p">,</span> <span class="s">&quot;mouseover&quot;</span><span class="p">,</span> <span class="s">&quot;mouseout&quot;</span><span class="p">]</span> <span class="c1"># mouse events</span>
          <span class="nv">e = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span> <span class="s">&quot;MouseEvents&quot;</span>
          <span class="nv">args = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span>
            <span class="nv">detail: </span><span class="mi">1</span><span class="p">,</span>
            <span class="nv">screenX: </span><span class="mi">0</span><span class="p">,</span>
            <span class="nv">screenY: </span><span class="mi">0</span><span class="p">,</span>
            <span class="nv">clientX: </span><span class="mi">0</span><span class="p">,</span>
            <span class="nv">clientY: </span><span class="mi">0</span><span class="p">,</span>
            <span class="nv">ctrlKey: </span><span class="kc">false</span><span class="p">,</span>
            <span class="nv">altKey: </span><span class="kc">false</span><span class="p">,</span>
            <span class="nv">shiftKey: </span><span class="kc">false</span><span class="p">,</span>
            <span class="nv">metaKey: </span><span class="kc">false</span><span class="p">,</span>
            <span class="nv">button: </span><span class="mi">0</span><span class="p">,</span>
            <span class="nv">relatedTarget: </span><span class="kc">null</span>
          <span class="p">,</span> <span class="nx">args</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">initMouseEvent</span> <span class="nx">evt_i</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">bubbles</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">cancelable</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">global</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">detail</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">screenX</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">screenY</span><span class="p">,</span>
            <span class="nx">args</span><span class="p">.</span><span class="nx">clientX</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">clientY</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">ctrlKey</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">altKey</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shiftKey</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">metaKey</span><span class="p">,</span>
            <span class="nx">args</span><span class="p">.</span><span class="nx">button</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">relatedTarget</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">evt_i</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;blur&quot;</span><span class="p">,</span> <span class="s">&quot;focus&quot;</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span><span class="p">,</span> <span class="s">&quot;submit&quot;</span><span class="p">,</span> <span class="s">&quot;abort&quot;</span><span class="p">,</span> <span class="s">&quot;change&quot;</span><span class="p">,</span> <span class="s">&quot;load&quot;</span><span class="p">,</span> <span class="s">&quot;unload&quot;</span><span class="p">]</span> <span class="c1"># UI events</span>
          <span class="nv">e = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span> <span class="s">&quot;UIEvents&quot;</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">initUIEvent</span> <span class="nx">evt_i</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">bubbles</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">cancelable</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">global</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">evt_i</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;touchstart&quot;</span><span class="p">,</span> <span class="s">&quot;touchmove&quot;</span><span class="p">,</span> <span class="s">&quot;touchend&quot;</span><span class="p">,</span> <span class="s">&quot;touchcancel&quot;</span><span class="p">]</span> <span class="c1"># touch events</span>
          <span class="nv">e = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span> <span class="s">&quot;TouchEvents&quot;</span>
          <span class="nv">args = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span>
            <span class="nv">detail: </span><span class="mi">1</span><span class="p">,</span>
            <span class="nv">screenX: </span><span class="mi">0</span><span class="p">,</span>
            <span class="nv">screenY: </span><span class="mi">0</span><span class="p">,</span>
            <span class="nv">clientX: </span><span class="mi">0</span><span class="p">,</span>
            <span class="nv">clientY: </span><span class="mi">0</span><span class="p">,</span>
            <span class="nv">ctrlKey: </span><span class="kc">false</span><span class="p">,</span>
            <span class="nv">altKey: </span><span class="kc">false</span><span class="p">,</span>
            <span class="nv">shiftKey: </span><span class="kc">false</span><span class="p">,</span>
            <span class="nv">metaKey: </span><span class="kc">false</span><span class="p">,</span>
            <span class="nv">touches: </span><span class="p">[],</span>
            <span class="nv">targetTouches: </span><span class="p">[],</span>
            <span class="nv">changedTouches: </span><span class="p">[],</span>
            <span class="nv">scale: </span><span class="mf">1.0</span><span class="p">,</span>
            <span class="nv">rotation: </span><span class="mf">0.0</span>
          <span class="p">,</span> <span class="nx">args</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">initTouchEvent</span><span class="p">(</span><span class="nx">evt_i</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">bubbles</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">cancelable</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">global</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">detail</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">screenX</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">screenY</span><span class="p">,</span>
            <span class="nx">args</span><span class="p">.</span><span class="nx">clientX</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">clientY</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">ctrlKey</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">altKey</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shiftKey</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">metaKey</span><span class="p">,</span>
            <span class="nx">args</span><span class="p">.</span><span class="nx">touches</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">targetTouches</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">changedTouches</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">scale</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">rotation</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">evt_i</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;gesturestart&quot;</span><span class="p">,</span> <span class="s">&quot;gestureend&quot;</span><span class="p">,</span> <span class="s">&quot;gesturecancel&quot;</span><span class="p">]</span> <span class="c1"># gesture events</span>
          <span class="nv">e = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span> <span class="s">&quot;GestureEvents&quot;</span>
          <span class="nv">args = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{</span>
            <span class="nv">detail: </span><span class="mi">1</span><span class="p">,</span>
            <span class="nv">screenX: </span><span class="mi">0</span><span class="p">,</span>
            <span class="nv">screenY: </span><span class="mi">0</span><span class="p">,</span>
            <span class="nv">clientX: </span><span class="mi">0</span><span class="p">,</span>
            <span class="nv">clientY: </span><span class="mi">0</span><span class="p">,</span>
            <span class="nv">ctrlKey: </span><span class="kc">false</span><span class="p">,</span>
            <span class="nv">altKey: </span><span class="kc">false</span><span class="p">,</span>
            <span class="nv">shiftKey: </span><span class="kc">false</span><span class="p">,</span>
            <span class="nv">metaKey: </span><span class="kc">false</span><span class="p">,</span>
            <span class="nv">target: </span><span class="kc">null</span><span class="p">,</span>
            <span class="nv">scale: </span><span class="mf">1.0</span><span class="p">,</span>
            <span class="nv">rotation: </span><span class="mf">0.0</span>
          <span class="p">},</span> <span class="nx">args</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">initGestureEvent</span> <span class="nx">evt_i</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">bubbles</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">cancelable</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">global</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">detail</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">screenX</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">screenY</span><span class="p">,</span>
            <span class="nx">args</span><span class="p">.</span><span class="nx">clientX</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">clientY</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">ctrlKey</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">altKey</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shiftKey</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">metaKey</span><span class="p">,</span>
            <span class="nx">args</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">scale</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">rotation</span>
        <span class="k">else</span>
          <span class="nv">e = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span> <span class="s">&quot;Events&quot;</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">initEvent</span> <span class="nx">evt_i</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">bubbles</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">cancelable</span>
          <span class="k">try</span>
            <span class="nv">e = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">args</span>
          <span class="k">catch</span> <span class="nx">err</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">e</span>
          <span class="k">continue</span>
        <span class="k">else</span>
          <span class="k">try</span>
            <span class="nx">@each</span> <span class="o">-&gt;</span> <span class="nx">@dispatchEvent</span> <span class="nx">e</span>
          <span class="k">catch</span> <span class="nx">err</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;dispatchEvent error:&quot;</span><span class="p">,</span> <span class="nx">err</span>
      <span class="nx">@</span>
    <span class="nv">live: </span><span class="nf">(e, f) -&gt;</span>
      <span class="nv">selector = </span><span class="nx">@selector</span>
      <span class="nv">context = </span><span class="nx">@context</span>
      <span class="nv">handler = </span><span class="nf">(evt) -&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">intersect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">parents</span><span class="p">().</span><span class="nx">first</span><span class="p">().</span><span class="nx">union</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">)))</span>
          <span class="p">.</span><span class="nx">each</span> <span class="o">-&gt;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nv">evt.target = </span><span class="nx">@</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span>
      <span class="nx">register_live</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">handler</span>
      <span class="nx">@</span>
    <span class="nv">die: </span><span class="nf">(e, f) -&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">@context</span><span class="p">).</span><span class="nx">unbind</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">unregister_live</span><span class="p">(</span><span class="nx">@selector</span><span class="p">,</span> <span class="nx">@context</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span>
      <span class="nx">@</span>
    <span class="nv">click: </span><span class="nf">(f = {}) -&gt;</span>
      <span class="k">if</span> <span class="nx">@css</span><span class="p">(</span><span class="s">&quot;cursor&quot;</span><span class="p">)</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;auto&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">]</span>
        <span class="nx">@css</span> <span class="s">&quot;cursor&quot;</span><span class="p">,</span> <span class="s">&quot;pointer&quot;</span>
      <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;function&quot;</span><span class="p">,</span> <span class="nx">f</span> <span class="k">then</span> <span class="nx">@bind</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="nx">f</span>
      <span class="k">else</span> <span class="nx">@trigger</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="nx">f</span>
      <span class="nx">@</span>
    <span class="nv">ready: </span><span class="nf">(f) -&gt;</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@</span><span class="p">)</span> <span class="k">if</span> <span class="nx">triggerReady</span><span class="p">.</span><span class="nx">exhausted</span>
      <span class="nx">@bind</span> <span class="s">&quot;ready&quot;</span><span class="p">,</span> <span class="nx">f</span>
  <span class="p">}</span>
  <span class="nx">events</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(x) -&gt;</span> <span class="nx">ret</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">binder</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">ret</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;function&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;hash&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">$:</span>
    <span class="nv">identity: </span><span class="nf">(o) -&gt;</span> <span class="nx">o</span>
    <span class="o">not:</span> <span class="nf">(f) -&gt;</span> <span class="o">-&gt;</span> <span class="o">not</span> <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="nv">compose: </span><span class="nf">(f,g) -&gt;</span> <span class="nf">(x) -&gt;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="p">(</span><span class="nv">y = </span><span class="nx">g</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">x</span><span class="p">)))</span>
    <span class="o">and:</span> <span class="nf">(f,g) -&gt;</span> <span class="nf">(x) -&gt;</span> <span class="nx">g</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span><span class="nx">x</span><span class="p">)</span> <span class="o">and</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span><span class="nx">x</span><span class="p">)</span>
    <span class="nv">once: </span><span class="nf">(f, n=1) -&gt;</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span><span class="nx">arguments</span><span class="p">)</span> <span class="k">if</span> <span class="nx">n</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s">&quot;exhausted&quot;</span><span class="p">,</span>
          <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">n</span> <span class="o">&lt;=</span> <span class="mi">0</span>
    <span class="nv">cycle: </span><span class="nf">(f...) -&gt;</span>
      <span class="nv">i = </span><span class="o">-</span><span class="mi">1</span>
      <span class="o">-&gt;</span> <span class="nx">f</span><span class="p">[</span><span class="nv">i = </span><span class="o">++</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">f</span><span class="p">.</span><span class="nx">length</span><span class="p">].</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="nv">bound: </span><span class="nf">(t, f, args = []) -&gt;</span>
      <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;function&quot;</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">bind</span>
        <span class="nx">args</span><span class="p">.</span><span class="nx">splice</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">t</span>
        <span class="nv">r = </span><span class="nx">f</span><span class="p">.</span><span class="nx">bind</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">args</span>
      <span class="k">else</span>
        <span class="nv">r = </span><span class="nf">(a...) -&gt;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">t</span><span class="p">,</span> <span class="p">(</span><span class="nx">args</span> <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="k">else</span> <span class="nx">a</span><span class="p">)</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">r</span><span class="p">,</span> <span class="p">{</span> <span class="nv">toString: </span><span class="o">-&gt;</span> <span class="s">&quot;bound-method of </span><span class="si">#{</span><span class="nx">t</span><span class="si">}</span><span class="s">.</span><span class="si">#{</span><span class="nx">f</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span> <span class="p">}</span>
    <span class="nv">memoize: </span><span class="nf">(f) -&gt;</span>
      <span class="nv">cache = </span><span class="p">{}</span>
      <span class="nf">(a...) -&gt;</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">$</span><span class="p">.</span><span class="nx">hash</span> <span class="nx">a</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">a</span> <span class="c1"># BUG: skips cache if f returns null on purpose</span>
    <span class="nv">E: </span><span class="nf">(callback) -&gt;</span> <span class="nf">(f) -&gt;</span> <span class="nf">(err, data) -&gt;</span>
      <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">err</span>
      <span class="nx">callback</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">data</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;groupBy&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">groupBy: </span><span class="nf">(key) -&gt;</span>
    <span class="nv">groups = </span><span class="p">{}</span>
    <span class="k">switch</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span> <span class="nx">key</span>
      <span class="k">when</span> <span class="s">&#39;array&#39;</span><span class="p">,</span><span class="s">&#39;bling&#39;</span>
        <span class="nx">@each</span> <span class="o">-&gt;</span>
          <span class="nv">c = </span><span class="p">(</span><span class="nx">@</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">key</span><span class="p">).</span><span class="nx">join</span> <span class="s">&quot;,&quot;</span>
          <span class="p">(</span><span class="nx">groups</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span> <span class="o">or=</span> <span class="nx">$</span><span class="p">()).</span><span class="nx">push</span> <span class="nx">@</span>
      <span class="k">else</span> <span class="nx">@each</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nx">groups</span><span class="p">[</span><span class="nx">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]]</span> <span class="o">or=</span> <span class="nx">$</span><span class="p">()).</span><span class="nx">push</span> <span class="nx">@</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">valuesOf</span> <span class="nx">groups</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;hash&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;type&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">unknown: </span><span class="p">{</span> <span class="nv">hash: </span><span class="nf">(o) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">checksum</span> <span class="nx">$</span><span class="p">.</span><span class="nx">toString</span> <span class="nx">o</span> <span class="p">}</span>
    <span class="nv">object: </span> <span class="p">{</span> <span class="nv">hash: </span><span class="nf">(o) -&gt;</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nb">Object</span><span class="p">)</span> <span class="o">+</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">k</span><span class="p">])</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">o</span><span class="p">).</span><span class="nx">sum</span><span class="p">()</span> <span class="o">+</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">hash</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">o</span>
    <span class="p">}</span>
    <span class="nv">array: </span>  <span class="p">{</span> <span class="nv">hash: </span><span class="nf">(o) -&gt;</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nb">Array</span><span class="p">)</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">map</span> <span class="nx">$</span><span class="p">.</span><span class="nx">hash</span><span class="p">).</span><span class="nx">reduce</span> <span class="nf">(a,x) -&gt;</span>
        <span class="p">(</span><span class="nx">a</span><span class="o">*</span><span class="nx">a</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">x</span><span class="o">|</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">,</span> <span class="mi">1</span>
    <span class="p">}</span>
    <span class="nv">bool: </span>   <span class="p">{</span> <span class="nv">hash: </span><span class="nf">(o) -&gt;</span> <span class="nb">parseInt</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="nx">o</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nv">$:</span>
      <span class="nv">hash: </span><span class="nf">(x) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">hash</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
    <span class="nv">hash: </span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">hash</span> <span class="nx">@</span>
  <span class="p">}</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span> <span class="o">-&gt;</span>
  <span class="nv">$:</span>
    <span class="nv">histogram: </span><span class="nf">(data, bucket_width=1, output_width=80) -&gt;</span>
      <span class="nv">buckets = </span><span class="nx">$</span><span class="p">()</span>
      <span class="nv">len = </span><span class="mi">0</span>
      <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">data</span>
        <span class="nv">i = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span> <span class="nx">x</span> <span class="o">/</span> <span class="nx">bucket_width</span> <span class="p">)</span>
        <span class="nx">buckets</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">?=</span> <span class="mi">0</span>
        <span class="nx">buckets</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nv">len = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">len</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
      <span class="nv">buckets.length = </span><span class="nx">len</span>
      <span class="nv">max = </span><span class="nx">buckets</span><span class="p">.</span><span class="nx">max</span><span class="p">()</span>
      <span class="nv">buckets = </span><span class="nx">buckets</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nf">(x) -&gt;</span> <span class="nx">x</span> <span class="o">or</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nx">max</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">output_width</span><span class="p">)</span>
      <span class="nv">sum = </span><span class="nx">buckets</span><span class="p">.</span><span class="nx">sum</span><span class="p">()</span>
      <span class="nv">ret = </span><span class="s">&quot;&quot;</span>
      <span class="nv">pct_sum = </span><span class="mi">0</span>
      <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">len</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
        <span class="nv">end = </span><span class="p">(</span><span class="nx">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">bucket_width</span>
        <span class="nv">pct = </span><span class="p">(</span><span class="nx">buckets</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="nx">sum</span><span class="p">)</span>
        <span class="nx">pct_sum</span> <span class="o">+=</span> <span class="nx">pct</span>
        <span class="nx">ret</span> <span class="o">+=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">padLeft</span><span class="p">(</span><span class="nx">pct_sum</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;%&quot;</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="nx">$</span><span class="p">.</span><span class="nx">padRight</span><span class="p">(</span><span class="s">&quot; &lt; </span><span class="si">#{</span><span class="nx">end</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">$</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">buckets</span><span class="p">[</span><span class="nx">n</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span>
      <span class="nx">ret</span>
  <span class="nv">histogram: </span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">histogram</span> <span class="nx">@</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;hook&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;type&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">hooks = </span><span class="p">{}</span>
  <span class="nv">hook = </span><span class="nf">(name, args) -&gt;</span>
    <span class="nv">p = </span><span class="p">(</span><span class="nx">hooks</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">or=</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">args</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nv">prepend: </span><span class="nf">(obj) -&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">obj</span>
        <span class="nv">append: </span><span class="nf">(obj) -&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">obj</span>
      <span class="p">}</span>
    <span class="k">for</span> <span class="nx">func</span> <span class="k">in</span> <span class="nx">p</span>
      <span class="nv">args = </span><span class="nx">func</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">args</span>
    <span class="nx">args</span>
  <span class="nx">hook</span><span class="p">(</span><span class="s">&quot;bling-init&quot;</span><span class="p">).</span><span class="nx">prepend</span> <span class="nf">(args) -&gt;</span>
    <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
      <span class="nv">args = </span><span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">array</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">inherit</span> <span class="nx">Bling</span><span class="p">,</span> <span class="nx">args</span>
  <span class="nv">$: hook: </span><span class="nx">hook</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">depends: </span><span class="s">&quot;dom&quot;</span>
  <span class="nv">provides: </span><span class="s">&quot;http&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">formencode = </span><span class="nf">(obj) -&gt;</span> <span class="c1"># create &amp;foo=bar strings from object properties</span>
    <span class="nv">o = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="c1"># quickly remove all non-stringable items</span>
    <span class="p">(</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">i</span><span class="si">}</span><span class="s">=</span><span class="si">#{</span><span class="nx">escape</span> <span class="nx">o</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">of</span> <span class="nx">o</span><span class="p">).</span><span class="nx">join</span> <span class="s">&quot;&amp;&quot;</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">register</span> <span class="s">&quot;http&quot;</span><span class="p">,</span>
    <span class="nv">match: </span><span class="nf">(o) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isType</span> <span class="s">&#39;XMLHttpRequest&#39;</span><span class="p">,</span> <span class="nx">o</span>
    <span class="nv">array: </span><span class="nf">(o) -&gt;</span> <span class="p">[</span><span class="nx">o</span><span class="p">]</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nv">$:</span>
      <span class="nv">http: </span><span class="nf">(url, opts = {}) -&gt;</span>
        <span class="nv">xhr = </span><span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;function&quot;</span><span class="p">,</span> <span class="nx">opts</span>
          <span class="nv">opts = success: </span><span class="nx">$</span><span class="p">.</span><span class="nx">bound</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
        <span class="nv">opts = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{</span>
          <span class="nv">method: </span><span class="s">&quot;GET&quot;</span>
          <span class="nv">data: </span><span class="kc">null</span>
          <span class="nv">state: </span><span class="nx">$</span><span class="p">.</span><span class="nx">identity</span> <span class="c1"># onreadystatechange</span>
          <span class="nv">success: </span><span class="nx">$</span><span class="p">.</span><span class="nx">identity</span> <span class="c1"># onload</span>
          <span class="nv">error: </span><span class="nx">$</span><span class="p">.</span><span class="nx">identity</span> <span class="c1"># onerror</span>
          <span class="nv">async: </span><span class="kc">true</span>
          <span class="nv">asBlob: </span><span class="kc">false</span>
          <span class="nv">timeout: </span><span class="mi">0</span> <span class="c1"># milliseconds, 0 is forever</span>
          <span class="nv">followRedirects: </span><span class="kc">false</span>
          <span class="nv">withCredentials: </span><span class="kc">false</span>
        <span class="p">},</span> <span class="nx">opts</span>
        <span class="nv">opts.state = </span><span class="nx">$</span><span class="p">.</span><span class="nx">bound</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">state</span><span class="p">)</span>
        <span class="nv">opts.success = </span><span class="nx">$</span><span class="p">.</span><span class="nx">bound</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span>
        <span class="nv">opts.error = </span><span class="nx">$</span><span class="p">.</span><span class="nx">bound</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">data</span> <span class="o">and</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">method</span> <span class="o">is</span> <span class="s">&quot;GET&quot;</span>
          <span class="nx">url</span> <span class="o">+=</span> <span class="s">&quot;?&quot;</span> <span class="o">+</span> <span class="nx">formencode</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">data</span> <span class="o">and</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">method</span> <span class="o">is</span> <span class="s">&quot;POST&quot;</span>
          <span class="nv">opts.data = </span><span class="nx">formencode</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">async</span><span class="p">)</span>
        <span class="nv">xhr = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">xhr</span><span class="p">,</span>
          <span class="nv">asBlob: </span><span class="nx">opts</span><span class="p">.</span><span class="nx">asBlob</span>
          <span class="nv">timeout: </span><span class="nx">opts</span><span class="p">.</span><span class="nx">timeout</span>
          <span class="nv">followRedirects: </span><span class="nx">opts</span><span class="p">.</span><span class="nx">followRedirects</span>
          <span class="nv">withCredentials: </span><span class="nx">opts</span><span class="p">.</span><span class="nx">withCredentials</span>
          <span class="nv">onreadystatechange: </span><span class="o">-&gt;</span>
            <span class="nx">opts</span><span class="p">.</span><span class="nx">state</span><span class="o">?</span><span class="p">()</span>
            <span class="k">if</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">is</span> <span class="mi">4</span>
              <span class="k">if</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">is</span> <span class="mi">200</span>
                <span class="nx">opts</span><span class="p">.</span><span class="nx">success</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span>
              <span class="k">else</span>
                <span class="nx">opts</span><span class="p">.</span><span class="nx">error</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">statusText</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">data</span>
        <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span>
      <span class="nv">post: </span><span class="nf">(url, opts = {}) -&gt;</span>
        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;function&quot;</span><span class="p">,</span><span class="nx">opts</span><span class="p">)</span>
          <span class="nv">opts = success: </span><span class="nx">opts</span>
        <span class="nv">opts.method = </span><span class="s">&quot;POST&quot;</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">http</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
      <span class="nv">get: </span><span class="nf">(url, opts = {}) -&gt;</span>
        <span class="k">if</span><span class="p">(</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;function&quot;</span><span class="p">,</span><span class="nx">opts</span><span class="p">)</span> <span class="p">)</span>
          <span class="nv">opts = success: </span><span class="nx">opts</span>
        <span class="nv">opts.method = </span><span class="s">&quot;GET&quot;</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">http</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
  <span class="p">}</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">depends</span> <span class="s">&#39;hook&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">hook</span><span class="p">(</span><span class="s">&#39;bling-init&#39;</span><span class="p">).</span><span class="nx">append</span> <span class="nf">(obj) -&gt;</span>
    <span class="nv">map = </span><span class="p">{}</span>
    <span class="nv">keyMaker = </span><span class="kc">null</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">inherit</span> <span class="p">{</span>
      <span class="nv">index: </span><span class="nf">(keyFunc) -&gt;</span>
        <span class="nv">keyMaker = </span><span class="nx">keyFunc</span>
        <span class="nx">@each</span> <span class="nf">(x) -&gt;</span>
          <span class="nx">map</span><span class="p">[</span><span class="nx">keyFunc</span><span class="p">(</span><span class="nx">x</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">x</span>
      <span class="nv">query: </span><span class="nf">(criteria) -&gt;</span>
        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&#39;function&#39;</span><span class="p">,</span> <span class="nx">keyMaker</span>
          <span class="nv">key = </span><span class="nx">keyMaker</span><span class="p">(</span><span class="nx">criteria</span><span class="p">)</span>
          <span class="k">return</span> <span class="nx">map</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">if</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">map</span>
        <span class="kc">null</span>
    <span class="p">},</span> <span class="nx">obj</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">depends: </span><span class="s">&quot;dom&quot;</span>
  <span class="nv">provides: </span><span class="s">&quot;lazy&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">lazy_load = </span><span class="nf">(elementName, props) -&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s">&quot;head&quot;</span><span class="p">).</span><span class="nx">append</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">elementName</span><span class="p">),</span> <span class="nx">props</span>
  <span class="nv">$:</span>
    <span class="nv">script: </span><span class="nf">(src) -&gt;</span>
      <span class="nx">lazy_load</span> <span class="s">&quot;script&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nv">src: </span><span class="nx">src</span> <span class="p">}</span>
    <span class="nv">style: </span><span class="nf">(src) -&gt;</span>
      <span class="nx">lazy_load</span> <span class="s">&quot;link&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nv">href: </span><span class="nx">src</span><span class="p">,</span> <span class="nv">rel: </span><span class="s">&quot;stylesheet&quot;</span> <span class="p">}</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;math&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;core&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">bool: </span><span class="p">{</span> <span class="nv">number: </span><span class="nf">(o) -&gt;</span> <span class="k">if</span> <span class="nx">o</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span> <span class="p">}</span>
    <span class="nv">number: </span><span class="p">{</span> <span class="nv">bool: </span><span class="nf">(o) -&gt;</span> <span class="o">not</span> <span class="o">not</span> <span class="nx">o</span> <span class="p">}</span>
  <span class="nv">$:</span>
    <span class="nv">range: </span><span class="nf">(start, end, step = 1) -&gt;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">end</span><span class="o">?</span> <span class="k">then</span> <span class="p">(</span><span class="nv">end = </span><span class="nx">start</span><span class="p">;</span> <span class="nv">start = </span><span class="mi">0</span><span class="p">)</span>
      <span class="nx">step</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nx">end</span> <span class="o">&lt;</span> <span class="nx">start</span> <span class="o">and</span> <span class="nx">step</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="c1"># force step to have the same sign as start-&gt;end</span>
      <span class="nx">$</span><span class="p">(</span> <span class="p">(</span><span class="nx">start</span> <span class="o">+</span> <span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="nx">step</span><span class="p">))</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span> <span class="p">(</span><span class="nx">end</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span> <span class="o">/</span> <span class="nx">step</span> <span class="p">)]</span> <span class="p">)</span>
    <span class="nv">zeros: </span><span class="nf">(n) -&gt;</span> <span class="nx">$</span><span class="p">(</span> <span class="mi">0</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">n</span><span class="p">]</span> <span class="p">)</span>
    <span class="nv">ones: </span><span class="nf">(n) -&gt;</span> <span class="nx">$</span><span class="p">(</span> <span class="mi">1</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">n</span><span class="p">]</span> <span class="p">)</span>
    <span class="nv">deg2rad: </span><span class="nf">(n) -&gt;</span> <span class="nx">n</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">180</span>
    <span class="nv">rad2deg: </span><span class="nf">(n) -&gt;</span> <span class="nx">n</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span>
  <span class="nv">floats: </span><span class="o">-&gt;</span> <span class="nx">@map</span> <span class="nb">parseFloat</span>
  <span class="nv">ints: </span><span class="o">-&gt;</span> <span class="nx">@map</span> <span class="o">-&gt;</span> <span class="nb">parseInt</span> <span class="nx">@</span><span class="p">,</span> <span class="mi">10</span>
  <span class="nv">px: </span><span class="nf">(delta) -&gt;</span> <span class="nx">@ints</span><span class="p">().</span><span class="nx">map</span> <span class="o">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">px</span> <span class="nx">@</span><span class="p">,</span><span class="nx">delta</span>
  <span class="nv">min: </span><span class="o">-&gt;</span> <span class="nx">@filter</span><span class="p">(</span> <span class="nb">isFinite</span> <span class="p">).</span><span class="nx">reduce</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span>
  <span class="nv">max: </span><span class="o">-&gt;</span> <span class="nx">@filter</span><span class="p">(</span> <span class="nb">isFinite</span> <span class="p">).</span><span class="nx">reduce</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span>
  <span class="nv">mean: mean = </span><span class="o">-&gt;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@length</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="nx">@sum</span><span class="p">()</span> <span class="o">/</span> <span class="nx">@length</span>
  <span class="nv">avg: </span><span class="nx">mean</span>
  <span class="nv">sum: </span><span class="o">-&gt;</span> <span class="nx">@filter</span><span class="p">(</span> <span class="nb">isFinite</span> <span class="p">).</span><span class="nx">reduce</span><span class="p">((</span><span class="nf">(a) -&gt;</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">@</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
  <span class="nv">product: </span><span class="o">-&gt;</span> <span class="nx">@filter</span><span class="p">(</span> <span class="nb">isFinite</span> <span class="p">).</span><span class="nx">reduce</span> <span class="nf">(a) -&gt;</span> <span class="nx">a</span> <span class="o">*</span> <span class="nx">@</span>
  <span class="nv">squares: </span><span class="o">-&gt;</span> <span class="nx">@pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="nv">pow: </span><span class="nf">(n) -&gt;</span> <span class="nx">@map</span> <span class="o">-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">n</span>
  <span class="nv">magnitude: </span><span class="o">-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span> <span class="nx">@floats</span><span class="p">().</span><span class="nx">squares</span><span class="p">().</span><span class="nx">sum</span><span class="p">()</span>
  <span class="nv">scale: </span><span class="nf">(r) -&gt;</span> <span class="nx">@map</span> <span class="o">-&gt;</span> <span class="nx">r</span> <span class="o">*</span> <span class="nx">@</span>
  <span class="nv">add: </span><span class="nf">(d) -&gt;</span> <span class="k">switch</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
    <span class="k">when</span> <span class="s">&quot;number&quot;</span> <span class="k">then</span> <span class="nx">@map</span> <span class="o">-&gt;</span> <span class="nx">d</span> <span class="o">+</span> <span class="nx">@</span>
    <span class="k">when</span> <span class="s">&quot;bling&quot;</span><span class="p">,</span><span class="s">&quot;array&quot;</span> <span class="k">then</span> <span class="nx">$</span><span class="p">(</span> <span class="nx">@</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">+</span><span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">@length</span><span class="p">,</span><span class="nx">d</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span> <span class="p">)</span>
  <span class="nv">normalize: </span><span class="o">-&gt;</span> <span class="nx">@scale</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">@magnitude</span><span class="p">()</span>
  <span class="nv">deg2rad: </span><span class="o">-&gt;</span> <span class="nx">@filter</span><span class="p">(</span> <span class="nb">isFinite</span> <span class="p">).</span><span class="nx">map</span> <span class="o">-&gt;</span> <span class="nx">@</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">180</span>
  <span class="nv">rad2deg: </span><span class="o">-&gt;</span> <span class="nx">@filter</span><span class="p">(</span> <span class="nb">isFinite</span> <span class="p">).</span><span class="nx">map</span> <span class="o">-&gt;</span> <span class="nx">@</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;pubsub&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">subscribers = </span><span class="p">{}</span> <span class="c1"># a mapping of channel name to a list of subscribers</span>
  <span class="nv">$:</span>
    <span class="nv">publish: </span><span class="nf">(e, args...) -&gt;</span>
      <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">args</span> <span class="k">for</span> <span class="nx">f</span> <span class="k">in</span> <span class="p">(</span><span class="nx">subscribers</span><span class="p">[</span><span class="nx">e</span><span class="p">]</span> <span class="o">or=</span> <span class="p">[])</span>
      <span class="nx">args</span>
    <span class="nv">publisher: </span><span class="nf">(e, func) -&gt;</span>
      <span class="nf">(args...) -&gt;</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">args</span>
    <span class="nv">subscribe: </span><span class="nf">(e, func) -&gt;</span>
      <span class="p">(</span><span class="nx">subscribers</span><span class="p">[</span><span class="nx">e</span><span class="p">]</span> <span class="o">or=</span> <span class="p">[]).</span><span class="nx">push</span> <span class="nx">func</span>
      <span class="nx">func</span>
    <span class="nv">unsubscribe: </span><span class="nf">(e, func) -&gt;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">func</span><span class="o">?</span>
        <span class="nx">subscribers</span><span class="p">[</span><span class="nx">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">else</span>
        <span class="nv">a = </span><span class="p">(</span><span class="nx">subscribers</span><span class="p">[</span><span class="nx">e</span><span class="p">]</span> <span class="o">or=</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">i = </span><span class="nx">a</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">func</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
          <span class="nx">a</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&#39;random&#39;</span>
  <span class="nv">depends: </span><span class="s">&#39;type&#39;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">alphabet = </span><span class="s">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><span class="p">.</span><span class="nx">split</span> <span class="s">&quot;&quot;</span>
  <span class="nv">$: random: </span><span class="nx">do</span> <span class="o">-&gt;</span> <span class="c1"># Mersenne Twister algorithm, from the psuedocode on wikipedia</span>
    <span class="nv">MT = </span><span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">624</span><span class="p">)</span>
    <span class="nv">index = </span><span class="mi">0</span>
    <span class="nv">init_generator = </span><span class="nf">(seed) -&gt;</span>
      <span class="nv">index = </span><span class="mi">0</span>
      <span class="nx">MT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">seed</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="mi">623</span><span class="p">]</span>
        <span class="nx">MT</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1812433253</span> <span class="o">*</span> <span class="p">(</span><span class="nx">MT</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="nx">MT</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">30</span><span class="p">))</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)</span>
    
    <span class="nv">generate_numbers = </span><span class="o">-&gt;</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">623</span><span class="p">]</span>
        <span class="nv">y = </span><span class="p">((</span><span class="nx">MT</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x7FFFFFFF</span> <span class="o">&amp;</span> <span class="nx">MT</span><span class="p">[</span> <span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">624</span> <span class="p">])</span>
        <span class="nx">MT</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MT</span><span class="p">[</span> <span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">397</span><span class="p">)</span> <span class="o">%</span> <span class="mi">624</span> <span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">y</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="o">is</span> <span class="mi">1</span>
          <span class="nx">MT</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MT</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">^</span> <span class="mi">2567483615</span>
    <span class="nv">a = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">31</span><span class="p">)</span>
    <span class="nv">b = </span><span class="nx">a</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="nv">next = </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nx">index</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="nx">generate_numbers</span><span class="p">()</span>
      <span class="nv">y = </span><span class="nx">MT</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">^</span>
        <span class="p">(</span><span class="nx">y</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">^</span>
        <span class="p">((</span><span class="nx">y</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">and</span> <span class="mi">2636928640</span><span class="p">)</span> <span class="o">^</span>
        <span class="p">((</span><span class="nx">y</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">and</span> <span class="mi">4022730752</span><span class="p">)</span> <span class="o">^</span>
        <span class="p">(</span><span class="nx">y</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span>
      <span class="nv">index = </span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">624</span>
      <span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">a</span><span class="p">)</span> <span class="o">/</span> <span class="nx">b</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nx">next</span><span class="p">,</span> <span class="s">&quot;seed&quot;</span><span class="p">,</span>
      <span class="nv">set: </span><span class="nf">(v) -&gt;</span> <span class="nx">init_generator</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
    
    <span class="nv">next.seed = </span><span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">next</span><span class="p">,</span>
      <span class="nv">real: </span><span class="nf">(min, max) -&gt;</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">min</span><span class="o">?</span>
          <span class="p">[</span><span class="nx">min</span><span class="p">,</span><span class="nx">max</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">max</span><span class="o">?</span>
          <span class="p">[</span><span class="nx">min</span><span class="p">,</span><span class="nx">max</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="nx">min</span><span class="p">]</span>
        <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">max</span> <span class="o">-</span> <span class="nx">min</span><span class="p">))</span> <span class="o">+</span> <span class="nx">min</span>
      <span class="nv">integer: </span><span class="nf">(min, max) -&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">$</span><span class="p">.</span><span class="nx">random</span><span class="p">.</span><span class="nx">real</span><span class="p">(</span><span class="nx">min</span><span class="p">,</span><span class="nx">max</span><span class="p">)</span>
      <span class="nv">string: </span><span class="nf">(len, prefix=&quot;&quot;) -&gt;</span>
        <span class="nx">prefix</span> <span class="o">+=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">random</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span><span class="nx">alphabet</span><span class="p">)</span> <span class="k">while</span> <span class="nx">prefix</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">len</span>
        <span class="nx">prefix</span>
      <span class="nv">coin: </span><span class="nf">(balance=.5) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="nx">balance</span>
      <span class="nv">element: </span><span class="nf">(arr) -&gt;</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">$</span><span class="p">.</span><span class="nx">random</span><span class="p">.</span><span class="nx">integer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span>
      <span class="nv">gaussian: </span><span class="nf">(mean=0.5, ssig=0.12) -&gt;</span> <span class="c1"># paraphrased from Wikipedia</span>
        <span class="k">while</span> <span class="kc">true</span>
          <span class="nv">u = </span><span class="nx">$</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span>
          <span class="nv">v = </span><span class="mf">1.7156</span> <span class="o">*</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
          <span class="nv">x = </span><span class="nx">u</span> <span class="o">-</span> <span class="mf">0.449871</span>
          <span class="nv">y = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.386595</span>
          <span class="nv">q = </span><span class="p">(</span><span class="nx">x</span><span class="o">*</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nx">y</span><span class="o">*</span><span class="p">(</span><span class="mf">0.19600</span><span class="o">*</span><span class="nx">y</span><span class="o">-</span><span class="mf">0.25472</span><span class="o">*</span><span class="nx">x</span><span class="p">)</span>
          <span class="k">break</span> <span class="nx">unless</span> <span class="nx">q</span> <span class="o">&gt;</span> <span class="mf">0.27597</span> <span class="o">and</span> <span class="p">(</span><span class="nx">q</span> <span class="o">&gt;</span> <span class="mf">0.27846</span> <span class="o">or</span> <span class="p">(</span><span class="nx">v</span><span class="o">*</span><span class="nx">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">u</span><span class="p">)</span><span class="o">*</span><span class="nx">u</span><span class="o">*</span><span class="nx">u</span><span class="p">))</span>
        <span class="k">return</span> <span class="nx">mean</span> <span class="o">+</span> <span class="nx">ssig</span><span class="o">*</span><span class="nx">v</span><span class="o">/</span><span class="nx">u</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;sendgrid&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;config&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="k">try</span>
    <span class="nv">nodemailer = </span><span class="nx">require</span> <span class="s">&#39;nodemailer&#39;</span>
  <span class="k">catch</span> <span class="nx">err</span>
    <span class="o">`</span><span class="k">return</span><span class="o">`</span>
  <span class="nv">transport = </span><span class="nx">nodemailer</span><span class="p">.</span><span class="nx">createTransport</span> <span class="s">&#39;SMTP&#39;</span><span class="p">,</span>
    <span class="nv">service: </span><span class="s">&#39;SendGrid&#39;</span>
    <span class="nv">auth:</span>
      <span class="nv">user: </span><span class="nx">$</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;SENDGRID_USERNAME&#39;</span>
      <span class="nv">pass: </span><span class="nx">$</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;SENDGRID_PASSWORD&#39;</span> <span class="c1"># this should be set manually by &#39;heroku config:add SENDGRID_PASSWORD=xyz123&#39;</span>
  <span class="nv">$:</span>
    <span class="nv">sendMail: </span><span class="nf">(mail, callback) -&gt;</span>
      <span class="nx">mail</span><span class="p">.</span><span class="nx">transport</span> <span class="o">?=</span> <span class="nx">transport</span>
      <span class="nx">mail</span><span class="p">.</span><span class="nx">from</span> <span class="o">?=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;EMAILS_FROM&#39;</span>
      <span class="nx">mail</span><span class="p">.</span><span class="nx">bcc</span> <span class="o">?=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;EMAILS_BCC&#39;</span>
      <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;SENDGRID_ENABLED&#39;</span><span class="p">,</span> <span class="s">&#39;true&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="s">&#39;true&#39;</span>
        <span class="nx">nodemailer</span><span class="p">.</span><span class="nx">sendMail</span> <span class="nx">mail</span><span class="p">,</span> <span class="nx">callback</span>
      <span class="k">else</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span> <span class="c1"># Reply as if an email was sent</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;string&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;function&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">safer = </span><span class="nf">(f) -&gt;</span>
    <span class="nf">(a...) -&gt;</span>
      <span class="k">try</span> <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">a</span><span class="p">...)</span>
      <span class="k">catch</span> <span class="nx">err</span> <span class="k">then</span> <span class="k">return</span> <span class="s">&quot;[Error: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">]&quot;</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">unknown:</span>
      <span class="nv">string: </span><span class="nx">safer</span> <span class="nf">(o) -&gt;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">toString</span><span class="o">?</span><span class="p">()</span> <span class="o">?</span> <span class="nb">String</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span>
      <span class="nv">repr: </span><span class="nx">safer</span> <span class="nf">(o) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">o</span><span class="p">).</span><span class="nx">string</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span>
      <span class="nv">number: </span><span class="nx">safer</span> <span class="nf">(o) -&gt;</span> <span class="nb">parseFloat</span> <span class="nb">String</span> <span class="nx">o</span>
    <span class="kc">null</span><span class="o">:</span> <span class="p">{</span> <span class="nv">string: </span><span class="o">-&gt;</span> <span class="s">&quot;null&quot;</span> <span class="p">}</span>
    <span class="kc">undefined</span><span class="o">:</span> <span class="p">{</span> <span class="nv">string: </span><span class="o">-&gt;</span> <span class="s">&quot;undefined&quot;</span> <span class="p">}</span>
    <span class="nv">string:</span>
      <span class="nv">number: </span><span class="nx">safer</span> <span class="nb">parseFloat</span>
      <span class="nv">repr: </span>  <span class="nf">(s) -&gt;</span> <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">s</span><span class="si">}</span><span class="s">&#39;&quot;</span>
    <span class="nv">array: </span> <span class="p">{</span> <span class="nv">string: </span><span class="nx">safer</span> <span class="nf">(a) -&gt;</span> <span class="s">&quot;[&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span> <span class="p">}</span>
    <span class="nv">object: </span><span class="p">{</span> <span class="nv">string: </span><span class="nx">safer</span> <span class="nf">(o) -&gt;</span>
      <span class="nv">ret = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">o</span>
        <span class="k">try</span>
          <span class="nv">v = </span><span class="nx">o</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
        <span class="k">catch</span> <span class="nx">err</span>
          <span class="nv">v = </span><span class="s">&quot;[Error: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">]&quot;</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">k</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">$</span><span class="p">.</span><span class="nx">toString</span> <span class="nx">v</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="s">&quot;{&quot;</span> <span class="o">+</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span>
    <span class="p">}</span>
    <span class="nv">function:</span>
      <span class="nv">string: </span><span class="nf">(f) -&gt;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^([^{]*){(?:.|\n|\r)*}$/</span><span class="p">,</span> <span class="s">&#39;$1{ ... }&#39;</span><span class="p">)</span>
    <span class="nv">number:</span>
      <span class="nv">repr: </span>  <span class="nf">(n) -&gt;</span> <span class="nb">String</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
      <span class="nv">string: </span><span class="nx">safer</span> <span class="nf">(n) -&gt;</span>
        <span class="k">switch</span> <span class="kc">true</span>
          <span class="k">when</span> <span class="nx">n</span><span class="p">.</span><span class="nx">precision</span><span class="o">?</span> <span class="k">then</span> <span class="nx">n</span><span class="p">.</span><span class="nx">toPrecision</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">precision</span><span class="p">)</span>
          <span class="k">when</span> <span class="nx">n</span><span class="p">.</span><span class="nx">fixed</span><span class="o">?</span> <span class="k">then</span> <span class="nx">n</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">fixed</span><span class="p">)</span>
          <span class="k">else</span> <span class="nb">String</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nv">$:</span>
      <span class="nv">toString: </span><span class="nf">(x) -&gt;</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">x</span><span class="o">?</span> <span class="k">then</span> <span class="s">&quot;function Bling(selector, context) { [ ... ] }&quot;</span>
        <span class="k">else</span>
          <span class="k">try</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">string</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
          <span class="k">catch</span> <span class="nx">err</span>
            <span class="s">&quot;[Error: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">]&quot;</span>
      <span class="nv">toRepr: </span><span class="nf">(x) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">repr</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
      <span class="nv">px: </span><span class="nf">(x, delta=0) -&gt;</span> <span class="nx">x</span><span class="o">?</span> <span class="o">and</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">delta</span><span class="o">|</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;px&quot;</span>
      <span class="nv">capitalize: </span><span class="nf">(name) -&gt;</span> <span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">).</span><span class="nx">map</span> <span class="nf">(x) -&gt;</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">x</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()).</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
      <span class="nv">dashize: </span><span class="nf">(name) -&gt;</span>
        <span class="nv">ret = </span><span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...(</span><span class="nx">name</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span><span class="o">|</span><span class="mi">0</span><span class="p">)]</span>
          <span class="nv">c = </span><span class="nx">name</span><span class="p">.</span><span class="nx">charCodeAt</span> <span class="nx">i</span>
          <span class="k">if</span> <span class="mi">91</span> <span class="o">&gt;</span> <span class="nx">c</span> <span class="o">&gt;</span> <span class="mi">64</span>
            <span class="nx">c</span> <span class="o">+=</span> <span class="mi">32</span>
            <span class="nx">ret</span> <span class="o">+=</span> <span class="s">&#39;-&#39;</span>
          <span class="nx">ret</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
        <span class="nx">ret</span>
      <span class="nv">camelize: </span><span class="nf">(name) -&gt;</span>
        <span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">i = </span><span class="nx">name</span><span class="o">?</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
          <span class="nv">name = </span><span class="nx">$</span><span class="p">.</span><span class="nx">stringSplice</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="nx">name</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="nx">toUpperCase</span><span class="p">())</span>
        <span class="nx">name</span>
      <span class="nv">padLeft: </span><span class="nf">(s, n, c = &quot; &quot;) -&gt;</span>
        <span class="k">while</span> <span class="nx">s</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">n</span>
          <span class="nv">s = </span><span class="nx">c</span> <span class="o">+</span> <span class="nx">s</span>
        <span class="nx">s</span>
      <span class="nv">padRight: </span><span class="nf">(s, n, c = &quot; &quot;) -&gt;</span>
        <span class="k">while</span> <span class="nx">s</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">n</span>
          <span class="nv">s = </span><span class="nx">s</span> <span class="o">+</span> <span class="nx">c</span>
        <span class="nx">s</span>
      <span class="nv">stringTruncate: </span><span class="nf">(s, n, c = &quot;...&quot;) -&gt;</span>
        <span class="nv">s = </span><span class="nx">s</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="nv">r = </span><span class="p">[]</span>
        <span class="k">while</span> <span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="nv">x = </span><span class="nx">s</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
          <span class="nx">n</span> <span class="o">-=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span>
          <span class="k">if</span> <span class="nx">n</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">x</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">c</span>
      <span class="nv">stringCount: </span><span class="nf">(s, x, i = 0, n = 0) -&gt;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">j = </span><span class="nx">s</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">x</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">i</span><span class="o">-</span><span class="mi">1</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">stringCount</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span> <span class="nx">n</span>
      <span class="nv">stringSplice: </span><span class="nf">(s, i, j, n) -&gt;</span>
        <span class="nv">nn = </span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span>
        <span class="nv">end = </span><span class="nx">j</span>
        <span class="k">if</span> <span class="nx">end</span> <span class="o">&lt;</span> <span class="mi">0</span>
          <span class="nx">end</span> <span class="o">+=</span> <span class="nx">nn</span>
        <span class="nv">start = </span><span class="nx">i</span>
        <span class="k">if</span> <span class="nx">start</span> <span class="o">&lt;</span> <span class="mi">0</span>
          <span class="nx">start</span> <span class="o">+=</span> <span class="nx">nn</span>
        <span class="nx">s</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">start</span><span class="p">)</span> <span class="o">+</span> <span class="nx">n</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">end</span><span class="p">)</span>
      <span class="nv">checksum: </span><span class="nf">(s) -&gt;</span>
        <span class="nv">a = </span><span class="mi">1</span><span class="p">;</span> <span class="nv">b = </span><span class="mi">0</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
          <span class="nv">a = </span><span class="p">(</span><span class="nx">a</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="o">%</span> <span class="mi">65521</span>
          <span class="nv">b = </span><span class="p">(</span><span class="nx">b</span> <span class="o">+</span> <span class="nx">a</span><span class="p">)</span> <span class="o">%</span> <span class="mi">65521</span>
        <span class="p">(</span><span class="nx">b</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="nx">a</span>
      <span class="nv">repeat: </span><span class="nf">(x, n=2) -&gt;</span>
        <span class="k">switch</span> <span class="kc">true</span>
          <span class="k">when</span> <span class="nx">n</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">x</span>
          <span class="k">when</span> <span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="s">&quot;&quot;</span>
          <span class="k">when</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="nx">x</span> <span class="k">then</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">$</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
          <span class="k">else</span> <span class="nx">$</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">extend</span> <span class="nx">$</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="nv">stringBuilder: </span><span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;global&quot;</span><span class="p">,</span> <span class="nx">@</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">$</span><span class="p">.</span><span class="nx">stringBuilder</span><span class="p">()</span>
        <span class="nv">items = </span><span class="p">[]</span>
        <span class="vi">@length   = </span><span class="mi">0</span>
        <span class="vi">@append   = </span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">items</span><span class="p">.</span><span class="nx">push</span> <span class="nx">s</span><span class="p">;</span> <span class="nx">@length</span> <span class="o">+=</span> <span class="nx">s</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span><span class="o">|</span><span class="mi">0</span>
        <span class="vi">@prepend  = </span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">items</span><span class="p">.</span><span class="nx">splice</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">s</span><span class="p">;</span> <span class="nx">@length</span> <span class="o">+=</span> <span class="nx">s</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span><span class="o">|</span><span class="mi">0</span>
        <span class="vi">@clear    = </span><span class="p">(</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="nv">ret = </span><span class="nx">@toString</span><span class="p">();</span> <span class="nv">items = </span><span class="p">[];</span> <span class="vi">@length = </span><span class="mi">0</span><span class="p">;</span> <span class="nx">ret</span>
        <span class="vi">@toString = </span><span class="p">(</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">items</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="nx">@</span>
    <span class="nv">toString: </span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">toString</span> <span class="nx">@</span>
    <span class="nv">toRepr: </span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">toRepr</span> <span class="nx">@</span>
  <span class="p">}</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;symbol&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;type&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">symbol = </span><span class="kc">null</span>
  <span class="nv">cache = </span><span class="p">{}</span>
  <span class="nv">g = </span><span class="nx">$</span><span class="p">.</span><span class="nx">global</span>
  <span class="nv">g.Bling = </span><span class="nx">Bling</span>
  <span class="k">if</span> <span class="nx">module</span><span class="o">?</span>
    <span class="nv">module.exports = </span><span class="nx">Bling</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nx">$</span><span class="p">,</span> <span class="s">&quot;symbol&quot;</span><span class="p">,</span>
    <span class="nv">set: </span><span class="nf">(v) -&gt;</span>
      <span class="nx">g</span><span class="p">[</span><span class="nx">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">symbol</span><span class="p">]</span>
      <span class="nx">cache</span><span class="p">[</span><span class="nv">symbol = </span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">g</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span>
      <span class="nx">g</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Bling</span>
    <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">symbol</span>
  <span class="k">return</span> <span class="nv">$:</span>
    <span class="nv">symbol: </span><span class="s">&quot;$&quot;</span>
    <span class="nv">noConflict: </span><span class="o">-&gt;</span>
      <span class="nv">Bling.symbol = </span><span class="s">&quot;Bling&quot;</span>
      <span class="nx">Bling</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;StateMachine&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">$: StateMachine: </span><span class="k">class</span> <span class="nx">StateMachine</span>
    <span class="nv">constructor: </span><span class="nf">(stateTable) -&gt;</span>
      <span class="vi">@debug = </span><span class="kc">false</span>
      <span class="nx">@reset</span><span class="p">()</span>
      <span class="vi">@table = </span><span class="nx">stateTable</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nx">@</span><span class="p">,</span> <span class="s">&quot;modeline&quot;</span><span class="p">,</span>
        <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@table</span><span class="p">[</span><span class="nx">@_mode</span><span class="p">]</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nx">@</span><span class="p">,</span> <span class="s">&quot;mode&quot;</span><span class="p">,</span>
        <span class="nv">set: </span><span class="nf">(m) -&gt;</span>
          <span class="vi">@_lastMode = </span><span class="nx">@_mode</span>
          <span class="vi">@_mode = </span><span class="nx">m</span>
          <span class="k">if</span> <span class="nx">@_mode</span> <span class="o">isnt</span> <span class="nx">@_lastMode</span> <span class="o">and</span> <span class="nx">@modeline</span><span class="o">?</span> <span class="o">and</span> <span class="s">&#39;enter&#39;</span> <span class="k">of</span> <span class="nx">@modeline</span>
            <span class="nv">ret = </span><span class="nx">@modeline</span><span class="p">[</span><span class="s">&#39;enter&#39;</span><span class="p">].</span><span class="nx">call</span> <span class="nx">@</span>
            <span class="k">while</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;function&quot;</span><span class="p">,</span><span class="nx">ret</span><span class="p">)</span>
              <span class="nv">ret = </span><span class="nx">ret</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@</span>
          <span class="nx">m</span>
        <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@_mode</span>
    <span class="nv">reset: </span><span class="o">-&gt;</span>
      <span class="vi">@_mode = </span><span class="kc">null</span>
      <span class="vi">@_lastMode = </span><span class="kc">null</span>
    <span class="nv">GO: </span><span class="nf">(m) -&gt;</span> <span class="o">-&gt;</span> <span class="vi">@mode = </span><span class="nx">m</span>
    <span class="vi">@GO: </span><span class="nf">(m) -&gt;</span> <span class="o">-&gt;</span> <span class="vi">@mode = </span><span class="nx">m</span>
    
    <span class="nv">tick: </span><span class="nf">(c) -&gt;</span>
      <span class="nv">row = </span><span class="nx">@modeline</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">row</span><span class="o">?</span>
        <span class="nv">ret = </span><span class="kc">null</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">c</span> <span class="k">of</span> <span class="nx">row</span>
        <span class="nv">ret = </span><span class="nx">row</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span>
      <span class="k">else</span> <span class="k">if</span> <span class="s">&#39;def&#39;</span> <span class="k">of</span> <span class="nx">row</span>
        <span class="nv">ret = </span><span class="nx">row</span><span class="p">[</span><span class="s">&#39;def&#39;</span><span class="p">]</span>
      <span class="k">while</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;function&quot;</span><span class="p">,</span><span class="nx">ret</span>
        <span class="nv">ret = </span><span class="nx">ret</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">c</span>
      <span class="nx">ret</span>
    <span class="nv">run: </span><span class="nf">(inputs) -&gt;</span>
      <span class="vi">@mode = </span><span class="mi">0</span>
      <span class="k">for</span> <span class="nx">c</span> <span class="k">in</span> <span class="nx">inputs</span>
        <span class="nv">ret = </span><span class="nx">@tick</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;function&quot;</span><span class="p">,</span><span class="nx">@modeline</span><span class="o">?</span><span class="p">.</span><span class="nx">eof</span>
        <span class="nv">ret = </span><span class="nx">@modeline</span><span class="p">.</span><span class="nx">eof</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@</span>
      <span class="k">while</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;function&quot;</span><span class="p">,</span><span class="nx">ret</span>
        <span class="nv">ret = </span><span class="nx">ret</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@</span>
      <span class="nx">@reset</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">@</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;synth&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;StateMachine, type&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="k">class</span> <span class="nx">SynthMachine</span> <span class="k">extends</span> <span class="nx">$</span><span class="p">.</span><span class="nx">StateMachine</span>
    <span class="nv">basic =</span>
      <span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span><span class="o">:</span> <span class="nx">@GO</span> <span class="mi">2</span>
      <span class="s">&quot;.&quot;</span><span class="o">:</span> <span class="nx">@GO</span> <span class="mi">3</span>
      <span class="s">&quot;[&quot;</span><span class="o">:</span> <span class="nx">@GO</span> <span class="mi">4</span>
      <span class="s">&#39;&quot;&#39;</span><span class="o">:</span> <span class="nx">@GO</span> <span class="mi">6</span>
      <span class="s">&quot;&#39;&quot;</span><span class="o">:</span> <span class="nx">@GO</span> <span class="mi">7</span>
      <span class="s">&quot; &quot;</span><span class="o">:</span> <span class="nx">@GO</span> <span class="mi">8</span>
      <span class="s">&quot;,&quot;</span><span class="o">:</span> <span class="nx">@GO</span> <span class="mi">10</span>
      <span class="s">&quot;+&quot;</span><span class="o">:</span> <span class="nx">@GO</span> <span class="mi">11</span>
      <span class="nv">eof: </span><span class="nx">@GO</span> <span class="mi">13</span>
    <span class="vi">@STATE_TABLE = </span><span class="p">[</span>
      <span class="p">{</span> <span class="c1"># 0: START</span>
        <span class="nv">enter: </span><span class="o">-&gt;</span>
          <span class="vi">@tag = @id = @cls = @attr = @val = @text = </span><span class="s">&quot;&quot;</span>
          <span class="vi">@attrs = </span><span class="p">{}</span>
          <span class="nx">@GO</span> <span class="mi">1</span>
      <span class="p">},</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="c1"># 1: read a tag name</span>
        <span class="nv">def: </span><span class="nf">(c) -&gt;</span> <span class="nx">@tag</span> <span class="o">+=</span> <span class="nx">c</span>
      <span class="p">},</span> <span class="nx">basic</span><span class="p">),</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="c1"># 2: read an #id</span>
        <span class="nv">def: </span><span class="nf">(c) -&gt;</span> <span class="nx">@id</span> <span class="o">+=</span> <span class="nx">c</span>
      <span class="p">},</span> <span class="nx">basic</span><span class="p">),</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="c1"># 3: read a .class name</span>
        <span class="nv">enter: </span><span class="o">-&gt;</span> <span class="nx">@cls</span> <span class="o">+=</span> <span class="s">&quot; &quot;</span> <span class="k">if</span> <span class="nx">@cls</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nv">def: </span><span class="nf">(c) -&gt;</span> <span class="nx">@cls</span> <span class="o">+=</span> <span class="nx">c</span>
      <span class="p">},</span> <span class="nx">basic</span><span class="p">),</span>
      <span class="p">{</span> <span class="c1"># 4: read an attribute name (left-side)</span>
        <span class="s">&quot;=&quot;</span><span class="o">:</span> <span class="nx">@GO</span> <span class="mi">5</span>
        <span class="s">&quot;]&quot;</span><span class="o">:</span> <span class="o">-&gt;</span> <span class="nx">@attrs</span><span class="p">[</span><span class="nx">@attr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@val</span><span class="p">;</span> <span class="vi">@attr = @val = </span><span class="s">&quot;&quot;</span><span class="p">;</span> <span class="nx">@GO</span> <span class="mi">1</span>
        <span class="nv">def: </span><span class="nf">(c) -&gt;</span> <span class="nx">@attr</span> <span class="o">+=</span> <span class="nx">c</span>
        <span class="nv">eof: </span><span class="nx">@GO</span> <span class="mi">12</span>
      <span class="p">},</span>
      <span class="p">{</span> <span class="c1"># 5: read an attribute value (right-side)</span>
        <span class="s">&quot;]&quot;</span><span class="o">:</span> <span class="o">-&gt;</span> <span class="nx">@attrs</span><span class="p">[</span><span class="nx">@attr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@val</span><span class="p">;</span> <span class="vi">@attr = @val = </span><span class="s">&quot;&quot;</span><span class="p">;</span> <span class="nx">@GO</span> <span class="mi">1</span>
        <span class="nv">def: </span><span class="nf">(c) -&gt;</span> <span class="nx">@val</span> <span class="o">+=</span> <span class="nx">c</span>
        <span class="nv">eof: </span><span class="nx">@GO</span> <span class="mi">12</span>
      <span class="p">},</span>
      <span class="p">{</span> <span class="c1"># 6: read double-quoted text</span>
        <span class="s">&#39;&quot;&#39;</span><span class="o">:</span> <span class="nx">@GO</span> <span class="mi">8</span>
        <span class="nv">def: </span><span class="nf">(c) -&gt;</span> <span class="nx">@text</span> <span class="o">+=</span> <span class="nx">c</span>
        <span class="nv">eof: </span><span class="nx">@GO</span> <span class="mi">12</span>
      <span class="p">},</span>
      <span class="p">{</span> <span class="c1"># 7: read single-quoted text</span>
        <span class="s">&quot;&#39;&quot;</span><span class="o">:</span> <span class="nx">@GO</span> <span class="mi">8</span>
        <span class="nv">def: </span><span class="nf">(c) -&gt;</span> <span class="nx">@text</span> <span class="o">+=</span> <span class="nx">c</span>
        <span class="nv">eof: </span><span class="nx">@GO</span> <span class="mi">12</span>
      <span class="p">},</span>
      <span class="p">{</span> <span class="c1"># 8: emit text and continue</span>
        <span class="nv">enter: </span><span class="o">-&gt;</span>
          <span class="nx">@emitNode</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@tag</span>
          <span class="nx">@emitText</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@text</span>
          <span class="nx">@GO</span> <span class="mi">0</span>
      <span class="p">},</span>
      <span class="p">{},</span> <span class="c1"># 9: empty</span>
      <span class="p">{</span> <span class="c1"># 10: emit node and start a new tree</span>
        <span class="nv">enter: </span><span class="o">-&gt;</span>
          <span class="nx">@emitNode</span><span class="p">()</span>
          <span class="vi">@cursor = </span><span class="kc">null</span>
          <span class="nx">@GO</span> <span class="mi">0</span>
      <span class="p">},</span>
      <span class="p">{</span> <span class="c1"># 11: emit node and step sideways to create a sibling</span>
        <span class="nv">enter: </span><span class="o">-&gt;</span>
          <span class="nx">@emitNode</span><span class="p">()</span>
          <span class="vi">@cursor = </span><span class="nx">@cursor</span><span class="o">?</span><span class="p">.</span><span class="nx">parentNode</span>
          <span class="nx">@GO</span> <span class="mi">0</span>
      <span class="p">},</span>
      <span class="p">{</span> <span class="c1"># 12: ERROR</span>
        <span class="nv">enter: </span><span class="o">-&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Error in synth expression: </span><span class="si">#{</span><span class="nx">@input</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span> <span class="c1"># 13: FINALIZE</span>
        <span class="nv">enter: </span><span class="o">-&gt;</span>
          <span class="nx">@emitNode</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@tag</span>
          <span class="nx">@emitText</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@text</span>
      <span class="p">}</span>
    <span class="p">]</span>
    <span class="nv">constructor: </span><span class="o">-&gt;</span>
      <span class="k">super</span><span class="p">(</span><span class="nx">SynthMachine</span><span class="p">.</span><span class="nx">STATE_TABLE</span><span class="p">)</span>
      <span class="vi">@fragment = @cursor = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">()</span>
    <span class="nv">emitNode: </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nx">@tag</span>
        <span class="nv">node = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="nx">@tag</span>
        <span class="nv">node.id = </span><span class="nx">@id</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">node.className = </span><span class="nx">@cls</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">@attrs</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">setAttribute</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">@attrs</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
        <span class="nx">@cursor</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">node</span>
        <span class="vi">@cursor = </span><span class="nx">node</span>
    <span class="nv">emitText: </span><span class="o">-&gt;</span>
      <span class="nx">@cursor</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s">&quot;&lt;html&gt;&quot;</span><span class="p">).</span><span class="nx">node</span><span class="p">(</span><span class="nx">@text</span><span class="p">)</span>
      <span class="vi">@text = </span><span class="s">&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nv">$:</span>
      <span class="nv">synth: </span><span class="nf">(expr) -&gt;</span>
        <span class="nv">s = </span><span class="k">new</span> <span class="nx">SynthMachine</span><span class="p">()</span>
        <span class="nx">s</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">fragment</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">fragment</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">fragment</span><span class="p">)</span>
  <span class="p">}</span>
<span class="nx">do</span> <span class="nf">($ = Bling) -&gt;</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span> <span class="nf">() -&gt;</span> <span class="c1"># Template plugin, pythonic style: %(value).2f</span>
    <span class="nv">current_engine = </span><span class="kc">null</span>
    <span class="nv">engines = </span><span class="p">{}</span>
    <span class="nv">template = </span><span class="p">{</span>
      <span class="nv">register_engine: </span><span class="nf">(name, render_func) -&gt;</span>
        <span class="nx">engines</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">render_func</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">current_engine</span><span class="o">?</span>
          <span class="nv">current_engine = </span><span class="nx">name</span>
      <span class="nv">render: </span><span class="nf">(text, args) -&gt;</span>
        <span class="k">if</span> <span class="nx">current_engine</span> <span class="k">of</span> <span class="nx">engines</span>
          <span class="nx">engines</span><span class="p">[</span><span class="nx">current_engine</span><span class="p">](</span><span class="nx">text</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">template</span><span class="p">.</span><span class="nx">__defineSetter__</span> <span class="s">&#39;engine&#39;</span><span class="p">,</span> <span class="nf">(v) -&gt;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">engines</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;invalid template engine: </span><span class="si">#{</span><span class="nx">v</span><span class="si">}</span><span class="s"> not one of </span><span class="si">#{</span><span class="nb">Object</span><span class="p">.</span><span class="nx">Keys</span><span class="p">(</span><span class="nx">engines</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">else</span>
        <span class="nv">current_engine = </span><span class="nx">v</span>
    <span class="nx">template</span><span class="p">.</span><span class="nx">__defineGetter__</span> <span class="s">&#39;engine&#39;</span><span class="p">,</span> <span class="nf">() -&gt;</span> <span class="nx">current_engine</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nv">name: </span><span class="s">&#39;Template&#39;</span>
      <span class="nv">$:</span>
        <span class="nv">template: </span><span class="nx">template</span>
    <span class="p">}</span>
  
  <span class="nx">$</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">register_engine</span> <span class="s">&#39;null&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nf">() -&gt;</span>
    <span class="k">return</span> <span class="nf">(text, values) -&gt;</span>
      <span class="nx">text</span>
  <span class="p">)()</span>
  <span class="nv">match_forward = </span><span class="nf">(text, find, against, start, stop = -1) -&gt;</span> <span class="c1"># a brace-matcher, useful in most template parsing steps</span>
    <span class="nv">count = </span><span class="mi">1</span>
    <span class="k">if</span> <span class="nx">stop</span> <span class="o">&lt;</span> <span class="mi">0</span>
      <span class="nv">stop = </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="nx">stop</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">start</span><span class="p">...</span><span class="nx">stop</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
      <span class="nv">t = </span><span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">t</span> <span class="o">is</span> <span class="nx">against</span>
        <span class="nx">count</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">t</span> <span class="o">is</span> <span class="nx">find</span>
        <span class="nx">count</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="nx">count</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nx">i</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">register_engine</span> <span class="s">&#39;pythonic&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nf">() -&gt;</span>
    <span class="nv">type_re = </span><span class="sr">/([0-9#0+-]*)\.*([0-9#+-]*)([diouxXeEfFgGcrsqm])((?:.|\n)*)/</span> <span class="c1"># &#39;%.2f&#39; becomes [key, pad, fixed, type, remainder]</span>
    <span class="nv">chunk_re = </span><span class="sr">/%[\(\/]/</span>
    <span class="nv">compile = </span><span class="nf">(text) -&gt;</span>
      <span class="nv">chunks = </span><span class="nx">text</span><span class="p">.</span><span class="nx">split</span> <span class="nx">chunk_re</span>
      <span class="nv">n = </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">ret = </span><span class="p">[</span><span class="nx">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
      <span class="nv">j = </span><span class="mi">1</span> <span class="c1"># insert marker into ret</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">...</span><span class="nx">n</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
        <span class="nv">end = </span><span class="nx">match_forward</span> <span class="nx">chunks</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="s">&#39;)&#39;</span><span class="p">,</span> <span class="s">&#39;(&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="nx">end</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
          <span class="k">return</span> <span class="s">&quot;Template syntax error: unmatched &#39;%(&#39; starting at: </span><span class="si">#{</span><span class="nx">chunks</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nv">key = </span><span class="nx">chunks</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">substring</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">end</span>
        <span class="nv">rest = </span><span class="nx">chunks</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">substring</span> <span class="nx">end</span>
        <span class="nv">match = </span><span class="nx">type_re</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">rest</span>
        <span class="k">if</span> <span class="nx">match</span> <span class="o">is</span> <span class="kc">null</span>
          <span class="k">return</span> <span class="s">&quot;Template syntax error: invalid type specifier starting at &#39;</span><span class="si">#{</span><span class="nx">rest</span><span class="si">}</span><span class="s">&#39;&quot;</span>
        <span class="nv">rest = </span><span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="nx">ret</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span>
        <span class="nx">ret</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">|</span><span class="mi">0</span>
        <span class="nx">ret</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">|</span><span class="mi">0</span>
        <span class="nx">ret</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="nx">ret</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rest</span>
      <span class="k">return</span> <span class="nx">ret</span>
    <span class="nv">compile.cache = </span><span class="p">{}</span>
    <span class="nv">render = </span><span class="nf">(text, values) -&gt;</span> <span class="c1"># $.render(/t/, /v/) - replace markers in string /t/ with values from /v/</span>
      <span class="nv">cache = </span><span class="nx">compile</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">text</span><span class="p">]</span> <span class="c1"># get the cached version</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">cache</span><span class="o">?</span>
        <span class="nv">cache = </span><span class="nx">compile</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">text</span><span class="p">]</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="c1"># or compile and cache it</span>
      <span class="nv">output = </span><span class="p">[</span><span class="nx">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># the first block is always just text</span>
      <span class="nv">j = </span><span class="mi">1</span> <span class="c1"># insert marker into output</span>
      <span class="nv">n = </span><span class="nx">cache</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">n</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="k">by</span> <span class="mi">5</span>
        <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">pad</span><span class="p">,</span> <span class="nx">fixed</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">rest</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">i</span><span class="p">..</span><span class="nx">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
        <span class="nv">value = </span><span class="nx">values</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">value</span><span class="o">?</span>
          <span class="nv">value = </span><span class="s">&quot;missing value: </span><span class="si">#{</span><span class="nx">key</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="k">switch</span> <span class="nx">type</span>
          <span class="k">when</span> <span class="s">&#39;d&#39;</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
          <span class="k">when</span> <span class="s">&#39;f&#39;</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="nx">fixed</span><span class="p">)</span>
          <span class="k">when</span> <span class="s">&#39;s&#39;</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="nx">value</span>
          <span class="k">else</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="nx">value</span>
        <span class="k">if</span> <span class="nx">pad</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="nx">output</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">PadLeft</span> <span class="nx">output</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">pad</span>
        <span class="nx">output</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rest</span>
      <span class="nx">output</span><span class="p">.</span><span class="nx">join</span> <span class="s">&quot;&quot;</span>
    <span class="k">return</span> <span class="nx">render</span>
  <span class="p">)()</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">register_engine</span> <span class="s">&#39;js-eval&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nf">() -&gt;</span> <span class="c1"># work in progress...</span>
    <span class="k">class</span> <span class="nx">TemplateMachine</span> <span class="k">extends</span> <span class="nx">$</span><span class="p">.</span><span class="nx">StateMachine</span>
      <span class="vi">@STATE_TABLE = </span><span class="p">[</span>
        <span class="p">{</span> <span class="c1"># 0: START</span>
          <span class="nv">enter: </span><span class="nf">() -&gt;</span>
            <span class="vi">@data = </span><span class="p">[]</span>
            <span class="nx">@GO</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="c1"># 1: read anything</span>
        <span class="p">}</span>
      <span class="p">]</span>
      
    <span class="k">return</span> <span class="nf">(text, values) -&gt;</span>
      <span class="nx">text</span>
  <span class="p">)()</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;throttle&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;core&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">$:</span>
    <span class="nv">throttle: </span><span class="nf">(ms, f) -&gt;</span>
      <span class="nv">last = </span><span class="mi">0</span>
      <span class="nf">(a...) -&gt;</span>
        <span class="nv">gap = </span><span class="nx">$</span><span class="p">.</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">last</span>
        <span class="k">if</span> <span class="nx">gap</span> <span class="o">&gt;</span> <span class="nx">ms</span>
          <span class="nx">last</span> <span class="o">+=</span> <span class="nx">gap</span>
          <span class="k">return</span> <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span><span class="nx">a</span>
        <span class="kc">null</span>
    <span class="nv">debounce: </span><span class="nf">(ms, f) -&gt;</span>
      <span class="nv">last = </span><span class="mi">0</span>
      <span class="nf">(a...) -&gt;</span>
        <span class="nx">last</span> <span class="o">+=</span> <span class="p">(</span><span class="nv">gap = </span><span class="nx">$</span><span class="p">.</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">last</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span><span class="nx">a</span> <span class="k">if</span> <span class="nx">gap</span> <span class="o">&gt;</span> <span class="nx">ms</span> <span class="k">else</span> <span class="kc">null</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span> <span class="nf">() -&gt;</span> <span class="c1"># TnetStrings plugin</span>
  <span class="nv">parseOne = </span><span class="nf">(data) -&gt;</span>
    <span class="nv">i = </span><span class="nx">data</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&quot;:&quot;</span>
    <span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">len = </span><span class="nb">parseInt</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">i</span><span class="p">],</span> <span class="mi">10</span>
      <span class="nv">item = </span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">...</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="nx">len</span><span class="p">]</span>
      <span class="nv">type = </span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="nx">len</span><span class="p">]</span>
      <span class="nv">extra = </span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">len</span><span class="o">+</span><span class="mi">2</span><span class="p">...]</span>
      <span class="nv">item = </span><span class="k">switch</span> <span class="nx">type</span>
        <span class="k">when</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span> <span class="k">then</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
        <span class="k">when</span> <span class="s">&quot;&#39;&quot;</span> <span class="k">then</span> <span class="nb">String</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
        <span class="k">when</span> <span class="s">&quot;!&quot;</span> <span class="k">then</span> <span class="p">(</span><span class="nx">item</span> <span class="o">is</span> <span class="s">&quot;true&quot;</span><span class="p">)</span>
        <span class="k">when</span> <span class="s">&quot;~&quot;</span> <span class="k">then</span> <span class="kc">null</span>
        <span class="k">when</span> <span class="s">&quot;]&quot;</span> <span class="k">then</span> <span class="nx">parseArray</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
        <span class="k">when</span> <span class="s">&quot;}&quot;</span> <span class="k">then</span> <span class="nx">parseObject</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">[</span><span class="nx">item</span><span class="p">,</span> <span class="nx">extra</span><span class="p">]</span>
    <span class="k">return</span> <span class="kc">undefined</span>
  <span class="nv">parseArray = </span><span class="nf">(x) -&gt;</span>
    <span class="nv">data = </span><span class="p">[]</span>
    <span class="k">while</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="p">[</span><span class="nx">one</span><span class="p">,</span> <span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parseOne</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">one</span><span class="p">)</span>
    <span class="nx">data</span>
  <span class="nv">parseObject = </span><span class="nf">(x) -&gt;</span>
    <span class="nv">data = </span><span class="p">{}</span>
    <span class="k">while</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parseOne</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
      <span class="p">[</span><span class="nx">value</span><span class="p">,</span> <span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parseOne</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
      <span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
    <span class="nx">data</span>
  <span class="nv">$:</span>
    <span class="nv">TNET:</span>
      <span class="nv">stringify: </span><span class="nf">(x) -&gt;</span>
        <span class="p">[</span><span class="nx">data</span><span class="p">,</span> <span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="k">switch</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span> <span class="nx">x</span>
          <span class="k">when</span> <span class="s">&quot;number&quot;</span> <span class="k">then</span> <span class="p">[</span><span class="nb">String</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span><span class="p">]</span>
          <span class="k">when</span> <span class="s">&quot;string&quot;</span> <span class="k">then</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">]</span>
          <span class="k">when</span> <span class="s">&quot;function&quot;</span> <span class="k">then</span> <span class="p">[</span><span class="nb">String</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span> <span class="s">&quot;&#39;&quot;</span><span class="p">]</span>
          <span class="k">when</span> <span class="s">&quot;boolean&quot;</span> <span class="k">then</span> <span class="p">[</span><span class="nb">String</span><span class="p">(</span><span class="o">not</span> <span class="o">not</span> <span class="nx">x</span><span class="p">),</span> <span class="s">&quot;!&quot;</span><span class="p">]</span>
          <span class="k">when</span> <span class="s">&quot;null&quot;</span> <span class="k">then</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;~&quot;</span><span class="p">]</span>
          <span class="k">when</span> <span class="s">&quot;undefined&quot;</span> <span class="k">then</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;~&quot;</span><span class="p">]</span>
          <span class="k">when</span> <span class="s">&quot;array&quot;</span> <span class="k">then</span> <span class="p">[(</span><span class="nx">$</span><span class="p">.</span><span class="nx">TNET</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="nx">x</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">),</span> <span class="s">&quot;]&quot;</span><span class="p">]</span>
          <span class="k">when</span> <span class="s">&quot;object&quot;</span> <span class="k">then</span> <span class="p">[(</span><span class="nx">$</span><span class="p">.</span><span class="nx">TNET</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span><span class="o">+</span><span class="nx">$</span><span class="p">.</span><span class="nx">TNET</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">x</span><span class="p">[</span><span class="nx">y</span><span class="p">])</span> <span class="k">for</span> <span class="nx">y</span> <span class="k">of</span> <span class="nx">x</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">),</span> <span class="s">&quot;}&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="o">|</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">data</span> <span class="o">+</span> <span class="nx">type</span>
      <span class="nv">parse: </span><span class="nf">(x) -&gt;</span>
        <span class="nx">parseOne</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="o">?</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;trace&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;function,type&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">unknown: </span><span class="p">{</span> <span class="nv">trace: </span><span class="nx">$</span><span class="p">.</span><span class="nx">identity</span> <span class="p">}</span>
    <span class="nv">object: </span> <span class="p">{</span> <span class="nv">trace: </span><span class="nf">(label, o, tracer) -&gt;</span> <span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">k</span><span class="p">],</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">label</span><span class="si">}</span><span class="s">.</span><span class="si">#{</span><span class="nx">k</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">tracer</span><span class="p">)</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">o</span><span class="p">));</span> <span class="nx">o</span> <span class="p">}</span>
    <span class="nv">array: </span>  <span class="p">{</span> <span class="nv">trace: </span><span class="nf">(label, o, tracer) -&gt;</span> <span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">label</span><span class="si">}</span><span class="s">[</span><span class="si">#{</span><span class="nx">i</span><span class="si">}</span><span class="s">]&quot;</span><span class="p">,</span> <span class="nx">tracer</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">o</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span><span class="p">);</span> <span class="nx">o</span> <span class="p">}</span>
    <span class="nv">function:</span>
      <span class="nv">trace: </span><span class="nf">(label, f, tracer) -&gt;</span>
        <span class="nx">label</span> <span class="o">or=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">name</span>
        <span class="nv">r = </span><span class="nf">(a...) -&gt;</span>
          <span class="nx">tracer</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span> <span class="o">or</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span><span class="si">}</span><span class="s">.</span><span class="si">#{</span><span class="nx">label</span><span class="si">}</span><span class="s">(</span><span class="si">#{</span><span class="nx">$</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">toRepr</span><span class="p">).</span><span class="nx">join</span> <span class="s">&#39;,&#39;</span><span class="si">}</span><span class="s">)&quot;</span>
          <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">a</span>
        <span class="nv">r.toString = </span><span class="o">-&gt;</span> <span class="s">&quot;{Trace &#39;</span><span class="si">#{</span><span class="nx">label</span><span class="si">}</span><span class="s">&#39; of </span><span class="si">#{</span><span class="nx">f</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">r</span>
  <span class="k">return</span> <span class="nv">$: trace: </span><span class="nf">(label, o, tracer) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="nx">label</span>
      <span class="p">[</span><span class="nx">tracer</span><span class="p">,</span> <span class="nx">o</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">o</span><span class="p">,</span> <span class="nx">label</span><span class="p">]</span>
    <span class="nx">tracer</span> <span class="o">or=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">log</span>
    <span class="nx">label</span> <span class="o">or=</span> <span class="s">&quot;&quot;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">o</span><span class="p">).</span><span class="nx">trace</span><span class="p">(</span><span class="nx">label</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">tracer</span><span class="p">)</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">depends: </span><span class="s">&quot;dom&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">COMMASEP = </span><span class="s">&quot;, &quot;</span>
  <span class="nv">speeds = </span><span class="c1"># constant speed names</span>
    <span class="s">&quot;slow&quot;</span><span class="o">:</span> <span class="mi">700</span>
    <span class="s">&quot;medium&quot;</span><span class="o">:</span> <span class="mi">500</span>
    <span class="s">&quot;normal&quot;</span><span class="o">:</span> <span class="mi">300</span>
    <span class="s">&quot;fast&quot;</span><span class="o">:</span> <span class="mi">100</span>
    <span class="s">&quot;instant&quot;</span><span class="o">:</span> <span class="mi">0</span>
    <span class="s">&quot;now&quot;</span><span class="o">:</span> <span class="mi">0</span>
  <span class="nv">accel_props_re = </span><span class="sr">/(?:scale(?:3d)*|translate(?:[XYZ]|3d)*|rotate(?:[XYZ]|3d)*)/</span>
  <span class="nv">updateDelay = </span><span class="mi">30</span> <span class="c1"># ms to wait for DOM changes to apply</span>
  <span class="nv">testStyle = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&quot;div&quot;</span><span class="p">).</span><span class="nx">style</span>
  <span class="nv">transformProperty = </span><span class="s">&quot;transform&quot;</span>
  <span class="nv">transitionProperty = </span><span class="s">&quot;transition-property&quot;</span>
  <span class="nv">transitionDuration = </span><span class="s">&quot;transition-duration&quot;</span>
  <span class="nv">transitionTiming = </span><span class="s">&quot;transition-timing-function&quot;</span>
  <span class="k">if</span> <span class="s">&quot;WebkitTransform&quot;</span> <span class="k">of</span> <span class="nx">testStyle</span>
    <span class="nv">transformProperty = </span><span class="s">&quot;-webkit-transform&quot;</span>
    <span class="nv">transitionProperty = </span><span class="s">&quot;-webkit-transition-property&quot;</span>
    <span class="nv">transitionDuration = </span><span class="s">&quot;-webkit-transition-duration&quot;</span>
    <span class="nv">transitionTiming = </span><span class="s">&quot;-webkit-transition-timing-function&quot;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="s">&quot;MozTransform&quot;</span> <span class="k">of</span> <span class="nx">testStyle</span>
    <span class="nv">transformProperty = </span><span class="s">&quot;-moz-transform&quot;</span>
    <span class="nv">transitionProperty = </span><span class="s">&quot;-moz-transition-property&quot;</span>
    <span class="nv">transitionDuration = </span><span class="s">&quot;-moz-transition-duration&quot;</span>
    <span class="nv">transitionTiming = </span><span class="s">&quot;-moz-transition-timing-function&quot;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="s">&quot;OTransform&quot;</span> <span class="k">of</span> <span class="nx">testStyle</span>
    <span class="nv">transformProperty = </span><span class="s">&quot;-o-transform&quot;</span>
    <span class="nv">transitionProperty = </span><span class="s">&quot;-o-transition-property&quot;</span>
    <span class="nv">transitionDuration = </span><span class="s">&quot;-o-transition-duration&quot;</span>
    <span class="nv">transitionTiming = </span><span class="s">&quot;-o-transition-timing-function&quot;</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nv">$:</span>
      <span class="nv">duration: </span><span class="nf">(speed) -&gt;</span>
        <span class="nv">d = </span><span class="nx">speeds</span><span class="p">[</span><span class="nx">speed</span><span class="p">]</span>
        <span class="k">return</span> <span class="nx">d</span> <span class="k">if</span> <span class="nx">d</span><span class="o">?</span>
        <span class="k">return</span> <span class="nb">parseFloat</span> <span class="nx">speed</span>
    <span class="nv">transform: </span><span class="nf">(end_css, speed, easing, callback) -&gt;</span>
      <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;function&quot;</span><span class="p">,</span><span class="nx">speed</span><span class="p">)</span>
        <span class="nv">callback = </span><span class="nx">speed</span>
        <span class="nv">speed = easing = </span><span class="kc">null</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;function&quot;</span><span class="p">,</span><span class="nx">easing</span><span class="p">)</span>
        <span class="nv">callback = </span><span class="nx">easing</span>
        <span class="nv">easing = </span><span class="kc">null</span>
      <span class="nx">speed</span> <span class="o">?=</span> <span class="s">&quot;normal&quot;</span>
      <span class="nx">easing</span> <span class="o">or=</span> <span class="s">&quot;ease&quot;</span>
      <span class="nv">duration = </span><span class="nx">$</span><span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">speed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;ms&quot;</span>
      <span class="nv">props = </span><span class="p">[]</span>
      <span class="nv">trans = </span><span class="s">&quot;&quot;</span>
      <span class="nv">css = </span><span class="p">{}</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">of</span> <span class="nx">end_css</span>
        <span class="k">if</span> <span class="nx">accel_props_re</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
          <span class="nv">ii = </span><span class="nx">end_css</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
          <span class="k">if</span> <span class="nx">ii</span><span class="p">.</span><span class="nx">join</span>
            <span class="nv">ii = </span><span class="nx">$</span><span class="p">(</span><span class="nx">ii</span><span class="p">).</span><span class="nx">px</span><span class="p">().</span><span class="nx">join</span> <span class="nx">COMMASEP</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">ii</span><span class="p">.</span><span class="nx">toString</span>
            <span class="nv">ii = </span><span class="nx">ii</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
          <span class="nx">trans</span> <span class="o">+=</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">ii</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
        <span class="k">else</span> <span class="nx">css</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">end_css</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">push</span> <span class="nx">i</span><span class="p">)</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">of</span> <span class="nx">css</span>
      <span class="k">if</span> <span class="nx">trans</span>
        <span class="nx">props</span><span class="p">.</span><span class="nx">push</span> <span class="nx">transformProperty</span>
      <span class="nx">css</span><span class="p">[</span><span class="nx">transitionProperty</span><span class="p">]</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">join</span> <span class="nx">COMMASEP</span>
      <span class="nx">css</span><span class="p">[</span><span class="nx">transitionDuration</span><span class="p">]</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">duration</span><span class="p">).</span><span class="nx">join</span> <span class="nx">COMMASEP</span>
      <span class="nx">css</span><span class="p">[</span><span class="nx">transitionTiming</span><span class="p">]</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">easing</span><span class="p">).</span><span class="nx">join</span> <span class="nx">COMMASEP</span>
      <span class="k">if</span> <span class="nx">trans</span>
        <span class="nx">css</span><span class="p">[</span><span class="nx">transformProperty</span><span class="p">]</span> <span class="o">=</span> <span class="nx">trans</span>
      <span class="nx">@css</span> <span class="nx">css</span>
      <span class="nx">@delay</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">callback</span>
    <span class="nv">hide: </span><span class="nf">(callback) -&gt;</span> <span class="c1"># .hide() - each node gets display:none</span>
      <span class="nx">@each</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">@style</span>
          <span class="vi">@_display = </span><span class="s">&quot;&quot;</span> <span class="c1"># stash the old display</span>
          <span class="k">if</span> <span class="nx">@style</span><span class="p">.</span><span class="nx">display</span> <span class="o">is</span> <span class="o">not</span> <span class="s">&quot;none&quot;</span>
            <span class="vi">@_display = </span><span class="nx">@syle</span><span class="p">.</span><span class="nx">display</span>
          <span class="vi">@style.display = </span><span class="s">&quot;none&quot;</span>
      <span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;hide&quot;</span>
      <span class="p">.</span><span class="nx">delay</span> <span class="nx">updateDelay</span><span class="p">,</span> <span class="nx">callback</span>
    <span class="nv">show: </span><span class="nf">(callback) -&gt;</span> <span class="c1"># .show() - show each node</span>
      <span class="nx">@each</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">@style</span>
          <span class="vi">@style.display = </span><span class="nx">@_display</span>
          <span class="k">delete</span> <span class="nx">@_display</span>
      <span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;show&quot;</span>
      <span class="p">.</span><span class="nx">delay</span> <span class="nx">updateDelay</span><span class="p">,</span> <span class="nx">callback</span>
    <span class="nv">toggle: </span><span class="nf">(callback) -&gt;</span> <span class="c1"># .toggle() - show each hidden node, hide each visible one</span>
      <span class="nx">@weave</span><span class="p">(</span><span class="nx">@css</span><span class="p">(</span><span class="s">&quot;display&quot;</span><span class="p">))</span>
        <span class="p">.</span><span class="nx">fold</span> <span class="nf">(display, node) -&gt;</span>
          <span class="k">if</span> <span class="nx">display</span> <span class="o">is</span> <span class="s">&quot;none&quot;</span>
            <span class="nv">node.style.display = </span><span class="nx">node</span><span class="p">.</span><span class="nx">_display</span> <span class="o">or</span> <span class="s">&quot;&quot;</span>
            <span class="k">delete</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_display</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">trigger</span> <span class="s">&quot;show&quot;</span>
          <span class="k">else</span>
            <span class="nv">node._display = </span><span class="nx">display</span>
            <span class="nv">node.style.display = </span><span class="s">&quot;none&quot;</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">trigger</span> <span class="s">&quot;hide&quot;</span>
          <span class="nx">node</span>
        <span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">updateDelay</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
    <span class="nv">fadeIn: </span><span class="nf">(speed, callback) -&gt;</span> <span class="c1"># .fadeIn() - fade each node to opacity 1.0</span>
      <span class="nx">@</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s">&#39;opacity&#39;</span><span class="p">,</span><span class="s">&#39;0.0&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">show</span> <span class="o">-&gt;</span>
          <span class="nx">@transform</span> <span class="p">{</span>
            <span class="nx">opacity</span><span class="o">:</span><span class="s">&quot;1.0&quot;</span><span class="p">,</span>
            <span class="nv">translate3d: </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
          <span class="p">},</span> <span class="nx">speed</span><span class="p">,</span> <span class="nx">callback</span>
    <span class="nv">fadeOut: </span><span class="nf">(speed, callback, x = 0.0, y = 0.0) -&gt;</span> <span class="c1"># .fadeOut() - fade each node to opacity:0.0</span>
      <span class="nx">@transform</span> <span class="p">{</span>
        <span class="nx">opacity</span><span class="o">:</span><span class="s">&quot;0.0&quot;</span><span class="p">,</span>
        <span class="nx">translate3d</span><span class="o">:</span><span class="p">[</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]</span>
      <span class="p">},</span> <span class="nx">speed</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">@hide</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span>
    <span class="nv">fadeLeft: </span><span class="nf">(speed, callback) -&gt;</span> <span class="nx">@fadeOut</span> <span class="nx">speed</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="o">+</span><span class="nx">@width</span><span class="p">().</span><span class="nx">first</span><span class="p">(),</span> <span class="mf">0.0</span>
    <span class="nv">fadeRight: </span><span class="nf">(speed, callback) -&gt;</span> <span class="nx">@fadeOut</span> <span class="nx">speed</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">@width</span><span class="p">().</span><span class="nx">first</span><span class="p">(),</span> <span class="mf">0.0</span>
    <span class="nv">fadeUp: </span><span class="nf">(speed, callback) -&gt;</span> <span class="nx">@fadeOut</span> <span class="nx">speed</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="o">+</span><span class="nx">@height</span><span class="p">().</span><span class="nx">first</span><span class="p">()</span>
    <span class="nv">fadeDown: </span><span class="nf">(speed, callback)  -&gt;</span> <span class="nx">@fadeOut</span> <span class="nx">speed</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nx">@height</span><span class="p">().</span><span class="nx">first</span><span class="p">()</span>
  <span class="p">}</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;type&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">isType = </span><span class="nf">(T, o) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">o</span><span class="o">?</span> <span class="k">then</span> <span class="nx">T</span> <span class="k">in</span> <span class="p">[</span><span class="nx">o</span><span class="p">,</span><span class="s">&quot;null&quot;</span><span class="p">,</span><span class="s">&quot;undefined&quot;</span><span class="p">]</span>
    <span class="k">else</span> <span class="nx">o</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">is</span> <span class="nx">T</span> <span class="o">or</span>
      <span class="nx">o</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="nx">T</span> <span class="o">or</span>
      <span class="nb">Object</span><span class="o">::</span><span class="nx">toString</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;[object </span><span class="si">#{</span><span class="nx">T</span><span class="si">}</span><span class="s">]&quot;</span> <span class="o">or</span>
      <span class="nx">isType</span> <span class="nx">T</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">__proto__</span> <span class="c1"># recursive</span>
  <span class="nv">inherit = </span><span class="nf">(parent, obj) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">parent</span> <span class="o">is</span> <span class="s">&quot;function&quot;</span>
      <span class="nv">parent = </span><span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span>
    <span class="k">if</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">__proto__</span> <span class="o">is</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span>
      <span class="nv">parent.__proto__ = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">__proto__</span>
    <span class="nv">obj.__proto__ = </span><span class="nx">parent</span>
    <span class="nx">obj</span>
  <span class="nv">_type = </span><span class="nx">do</span> <span class="o">-&gt;</span>
    <span class="nv">cache = </span><span class="p">{}</span>
    <span class="nv">base =</span>
      <span class="nv">name: </span><span class="s">&#39;unknown&#39;</span>
      <span class="nv">match: </span><span class="nf">(o) -&gt;</span> <span class="kc">true</span>
    <span class="nv">order = </span><span class="p">[]</span>
    <span class="nv">register = </span><span class="nf">(name, data) -&gt;</span>
      <span class="nx">order</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">name</span> <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">name</span> <span class="k">of</span> <span class="nx">cache</span><span class="p">)</span>
      <span class="nx">cache</span><span class="p">[</span><span class="nv">data.name = </span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="p">(</span><span class="nx">base</span> <span class="o">isnt</span> <span class="nx">data</span><span class="p">)</span> <span class="k">then</span> <span class="p">(</span><span class="nx">inherit</span> <span class="nx">base</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="k">else</span> <span class="nx">data</span>
      <span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">][</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(o) -&gt;</span> <span class="nx">o</span>
    <span class="nv">_extend = </span><span class="nf">(name, data) -&gt;</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">name</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span>
        <span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">register</span> <span class="nx">name</span><span class="p">,</span> <span class="p">{}</span>
        <span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">extend</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">],</span> <span class="nx">data</span>
      <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">name</span> <span class="o">is</span> <span class="s">&quot;object&quot;</span>
        <span class="p">(</span><span class="nx">_extend</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">name</span><span class="p">[</span><span class="nx">k</span><span class="p">])</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">name</span>
    <span class="nv">lookup = </span><span class="nf">(obj) -&gt;</span>
      <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">order</span>
        <span class="k">if</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">match</span><span class="p">.</span><span class="nx">call</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">obj</span>
          <span class="k">return</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
    <span class="nx">register</span> <span class="s">&quot;unknown&quot;</span><span class="p">,</span>   <span class="nx">base</span>
    <span class="nx">register</span> <span class="s">&quot;object&quot;</span><span class="p">,</span>    <span class="nv">match: </span><span class="o">-&gt;</span> <span class="k">typeof</span> <span class="nx">@</span> <span class="o">is</span> <span class="s">&quot;object&quot;</span>
    <span class="nx">register</span> <span class="s">&quot;error&quot;</span><span class="p">,</span>     <span class="nv">match: </span><span class="o">-&gt;</span> <span class="nx">isType</span> <span class="s">&#39;Error&#39;</span><span class="p">,</span> <span class="nx">@</span>
    <span class="nx">register</span> <span class="s">&quot;regexp&quot;</span><span class="p">,</span>    <span class="nv">match: </span><span class="o">-&gt;</span> <span class="nx">isType</span> <span class="s">&#39;RegExp&#39;</span><span class="p">,</span> <span class="nx">@</span>
    <span class="nx">register</span> <span class="s">&quot;string&quot;</span><span class="p">,</span>    <span class="nv">match: </span><span class="o">-&gt;</span> <span class="k">typeof</span> <span class="nx">@</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span> <span class="o">or</span> <span class="nx">isType</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">@</span>
    <span class="nx">register</span> <span class="s">&quot;number&quot;</span><span class="p">,</span>    <span class="nv">match: </span><span class="o">-&gt;</span> <span class="p">(</span><span class="nx">isType</span> <span class="nb">Number</span><span class="p">,</span> <span class="nx">@</span><span class="p">)</span> <span class="o">and</span> <span class="nx">@</span> <span class="o">isnt</span> <span class="kc">NaN</span>
    <span class="nx">register</span> <span class="s">&quot;bool&quot;</span><span class="p">,</span>      <span class="nv">match: </span><span class="o">-&gt;</span> <span class="k">typeof</span> <span class="nx">@</span> <span class="o">is</span> <span class="s">&quot;boolean&quot;</span> <span class="o">or</span> <span class="nb">String</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;true&quot;</span><span class="p">,</span><span class="s">&quot;false&quot;</span><span class="p">]</span>
    <span class="nx">register</span> <span class="s">&quot;array&quot;</span><span class="p">,</span>     <span class="nv">match: </span><span class="o">-&gt;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="o">?</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span> <span class="o">or</span> <span class="nx">isType</span> <span class="nb">Array</span><span class="p">,</span> <span class="nx">@</span>
    <span class="nx">register</span> <span class="s">&quot;function&quot;</span><span class="p">,</span>  <span class="nv">match: </span><span class="o">-&gt;</span> <span class="k">typeof</span> <span class="nx">@</span> <span class="o">is</span> <span class="s">&quot;function&quot;</span>
    <span class="nx">register</span> <span class="s">&quot;global&quot;</span><span class="p">,</span>    <span class="nv">match: </span><span class="o">-&gt;</span> <span class="k">typeof</span> <span class="nx">@</span> <span class="o">is</span> <span class="s">&quot;object&quot;</span> <span class="o">and</span> <span class="s">&#39;setInterval&#39;</span> <span class="k">of</span> <span class="nx">@</span> <span class="c1"># Use the same crude method as jQuery for detecting the window, not very safe but it does work in Node and the browser</span>
    <span class="nx">register</span> <span class="s">&quot;undefined&quot;</span><span class="p">,</span> <span class="nv">match: </span><span class="nf">(x) -&gt;</span> <span class="nx">x</span> <span class="o">is</span> <span class="kc">undefined</span>
    <span class="nx">register</span> <span class="s">&quot;null&quot;</span><span class="p">,</span>      <span class="nv">match: </span><span class="nf">(x) -&gt;</span> <span class="nx">x</span> <span class="o">is</span> <span class="kc">null</span>
    <span class="k">return</span> <span class="nx">extend</span> <span class="p">(</span><span class="nf">(o) -&gt;</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">o</span><span class="p">).</span><span class="nx">name</span><span class="p">),</span>
      <span class="nv">register: </span><span class="nx">register</span>
      <span class="nv">lookup: </span><span class="nx">lookup</span>
      <span class="nv">extend: </span><span class="nx">_extend</span>
      <span class="o">is:</span> <span class="nf">(t, o) -&gt;</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">t</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">match</span><span class="p">.</span><span class="nx">call</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">o</span>
      <span class="nv">as: </span><span class="nf">(t, o, rest...) -&gt;</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">o</span><span class="p">)[</span><span class="nx">t</span><span class="p">]</span><span class="o">?</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">rest</span><span class="p">...)</span>
  <span class="nx">_type</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">unknown: </span>  <span class="p">{</span> <span class="nv">array: </span><span class="nf">(o) -&gt;</span> <span class="p">[</span><span class="nx">o</span><span class="p">]</span> <span class="p">}</span>
    <span class="kc">null</span><span class="o">:</span>      <span class="p">{</span> <span class="nv">array: </span><span class="nf">(o) -&gt;</span> <span class="p">[]</span> <span class="p">}</span>
    <span class="kc">undefined</span><span class="o">:</span> <span class="p">{</span> <span class="nv">array: </span><span class="nf">(o) -&gt;</span> <span class="p">[]</span> <span class="p">}</span>
    <span class="nv">array: </span>    <span class="p">{</span> <span class="nv">array: </span><span class="nf">(o) -&gt;</span> <span class="nx">o</span> <span class="p">}</span>
    <span class="nv">number: </span>   <span class="p">{</span> <span class="nv">array: </span><span class="nf">(o) -&gt;</span> <span class="nx">Bling</span><span class="p">.</span><span class="nx">extend</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="nv">length: </span><span class="mi">0</span> <span class="p">}</span>
  <span class="nx">_type</span><span class="p">.</span><span class="nx">register</span> <span class="s">&quot;bling&quot;</span><span class="p">,</span>
    <span class="nv">match: </span> <span class="nf">(o) -&gt;</span> <span class="nx">o</span> <span class="o">and</span> <span class="nx">isType</span> <span class="nx">Bling</span><span class="p">,</span> <span class="nx">o</span>
    <span class="nv">array: </span> <span class="nf">(o) -&gt;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">toArray</span><span class="p">()</span>
    <span class="nv">hash: </span>  <span class="nf">(o) -&gt;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">Bling</span><span class="p">.</span><span class="nx">hash</span><span class="p">).</span><span class="nx">reduce</span> <span class="nf">(a,x) -&gt;</span> <span class="p">(</span><span class="nx">a</span><span class="o">*</span><span class="nx">a</span><span class="p">)</span><span class="o">+</span><span class="nx">x</span>
    <span class="nv">string: </span><span class="nf">(o) -&gt;</span> <span class="nx">Bling</span><span class="p">.</span><span class="nx">symbol</span> <span class="o">+</span> <span class="s">&quot;([&quot;</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nf">(x) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">string</span><span class="p">(</span><span class="nx">x</span><span class="p">)).</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;])&quot;</span>
    <span class="nv">repr: </span><span class="nf">(o) -&gt;</span> <span class="nx">Bling</span><span class="p">.</span><span class="nx">symbol</span> <span class="o">+</span> <span class="s">&quot;([&quot;</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nf">(x) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">repr</span><span class="p">(</span><span class="nx">x</span><span class="p">)).</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;])&quot;</span>
  <span class="nv">$:</span>
    <span class="nv">inherit: </span><span class="nx">inherit</span>
    <span class="nv">extend: </span><span class="nx">extend</span>
    <span class="nv">defineProperty: </span><span class="nf">(o, name, opts) -&gt;</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">extend</span><span class="p">({</span> <span class="nv">configurable: </span><span class="kc">true</span><span class="p">,</span> <span class="nv">enumerable: </span><span class="kc">true</span> <span class="p">},</span> <span class="nx">opts</span><span class="p">)</span>
      <span class="nx">o</span>
    <span class="nv">isType: </span><span class="nx">isType</span>
    <span class="nv">type: </span><span class="nx">_type</span>
    <span class="o">is:</span> <span class="nx">_type</span><span class="p">.</span><span class="o">is</span>
    <span class="nv">as: </span><span class="nx">_type</span><span class="p">.</span><span class="nx">as</span>
    <span class="nv">isSimple: </span><span class="nf">(o) -&gt;</span> <span class="nx">_type</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="s">&quot;number&quot;</span><span class="p">,</span> <span class="s">&quot;bool&quot;</span><span class="p">]</span>
    <span class="nv">isEmpty: </span><span class="nf">(o) -&gt;</span> <span class="nx">o</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">]</span> <span class="o">or</span> <span class="nx">o</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">or</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">o</span> <span class="o">is</span> <span class="s">&quot;object&quot;</span> <span class="o">and</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">o</span><span class="p">).</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span><span class="p">)</span>
  <span class="nv">defineProperty: </span><span class="nf">(name, opts) -&gt;</span> <span class="nx">@each</span> <span class="o">-&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">opts</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">plugin</span>
  <span class="nv">provides: </span><span class="s">&quot;unittest&quot;</span>
  <span class="nv">depends: </span><span class="s">&quot;core,function&quot;</span>
<span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">testCount = passCount = failCount = </span><span class="mi">0</span>
  <span class="nv">failed = </span><span class="p">[]</span>
  <span class="nv">invokeTest = </span><span class="nf">(group, name, func) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;function&quot;</span><span class="p">,</span> <span class="nx">func</span>
    <span class="nv">_log = </span><span class="nf">(msg) -&gt;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">group</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">... </span><span class="si">#{</span><span class="nx">msg</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">shouldFail = </span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&quot;fail&quot;</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nv">done = </span><span class="nx">$</span><span class="p">.</span><span class="nx">once</span> <span class="nf">(err) -&gt;</span>
      <span class="nx">testCount</span><span class="o">--</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="nx">err</span> <span class="o">isnt</span> <span class="nx">shouldFail</span><span class="p">)</span>
        <span class="nx">_log</span> <span class="s">&quot;fail: </span><span class="si">#{</span><span class="nx">err</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">failCount</span><span class="o">++</span>
        <span class="nx">failed</span><span class="p">.</span><span class="nx">push</span> <span class="nx">name</span>
      <span class="k">else</span>
        <span class="nx">_log</span> <span class="s">&quot;pass&quot;</span>
        <span class="nx">passCount</span><span class="o">++</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">provide</span> <span class="nx">name</span>
    <span class="nv">f = </span><span class="nf">(done) -&gt;</span>
      <span class="k">try</span> <span class="nx">func</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
      <span class="k">catch</span> <span class="nx">err</span> <span class="k">then</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">finally</span>
        <span class="k">if</span> <span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&quot;async&quot;</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nx">done</span><span class="p">()</span>
    <span class="nx">testCount</span><span class="o">++</span>
    <span class="k">try</span> <span class="nx">f</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
    <span class="k">catch</span> <span class="nx">err</span> <span class="k">then</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="nv">testReport = </span><span class="nx">$</span><span class="p">.</span><span class="nx">once</span> <span class="o">-&gt;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Passed: </span><span class="si">#{</span><span class="nx">passCount</span><span class="si">}</span><span class="s"> Failed: </span><span class="si">#{</span><span class="nx">failCount</span><span class="si">}</span><span class="s"> [</span><span class="si">#{</span><span class="nx">failed</span><span class="si">}</span><span class="s">]&quot;</span>
    <span class="k">if</span> <span class="nx">failCount</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">try</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="nx">failCount</span><span class="p">)</span>
  <span class="nv">$:</span>
    <span class="nv">approx: </span><span class="nf">(a, b, margin=.1) -&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">a</span> <span class="o">-</span> <span class="nx">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">margin</span>
    <span class="nv">assert: </span><span class="nf">(cnd, msg = &quot;no message&quot;) -&gt;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">cnd</span> <span class="k">then</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Assertion failed: </span><span class="si">#{</span><span class="nx">msg</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">assertEqual: </span><span class="nf">(a, b, label) -&gt;</span>
      <span class="k">if</span> <span class="nx">a</span> <span class="o">isnt</span> <span class="nx">b</span>
        <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">label</span> <span class="o">or</span> <span class="s">&#39;&#39;</span><span class="si">}</span><span class="s"> (</span><span class="si">#{</span><span class="nx">a</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="s">) should equal (</span><span class="si">#{</span><span class="nx">b</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="s">)&quot;</span>
    <span class="nv">assertArrayEqual: </span><span class="nf">(a, b, label) -&gt;</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
        <span class="k">try</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">assertEqual</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">label</span><span class="p">)</span>
        <span class="k">catch</span> <span class="nx">err</span>
          <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">label</span> <span class="o">or</span> <span class="s">&#39;&#39;</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">a</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="s"> should equal </span><span class="si">#{</span><span class="nx">b</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">testGroup: </span><span class="nf">(name, funcs) -&gt;</span>
      <span class="nv">interval = </span><span class="nx">setInterval</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="k">if</span> <span class="nx">testCount</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">interval</span><span class="p">);</span> <span class="nx">testReport</span><span class="p">()),</span> <span class="mi">50</span>
      <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">func</span> <span class="k">of</span> <span class="nx">funcs</span>
        <span class="nx">invokeTest</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span>
  <span class="nv">assertEqual: </span><span class="nf">(args...) -&gt;</span>
    <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="c1"># short-cut the trivial cases</span>
      <span class="nv">args = </span><span class="nx">args</span><span class="p">.</span><span class="nx">map</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="c1"># call any functions passed as arguments</span>
        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="o">is</span> <span class="s">&quot;function&quot;</span><span class="p">,</span> <span class="nx">x</span> <span class="k">then</span> <span class="nx">x</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span><span class="nx">@</span><span class="p">)</span> <span class="k">else</span> <span class="nx">x</span>
      <span class="nv">a = </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">...</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">assertEqual</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">@</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 